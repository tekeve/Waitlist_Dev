{% extends "base.html" %}
{% load humanize %}

{% block title %}EVE Waitlist - View{% endblock %}

{% block styles %}
<style>
    .waitlist-container {
        display: flex;
        flex-direction: row;
        gap: 10px;
        padding: 10px;
        overflow-x: auto;
        height: calc(100vh - var(--header-height) - 20px); /* Full height minus header */
    }

    .waitlist-column {
        flex: 1 0 280px; /* MODIFIED: Was 300px */
        min-width: 280px; /* MODIFIED: Was 300px */
        max-width: 320px; /* MODIFIED: Was 340px */
        display: flex;
        flex-direction: column;
        background: none; /* MODIFIED: Removed column background */
        border-radius: 8px;
        height: 100%;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 2px solid #444;
    }

        .column-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: #fff;
        }

    .column-count {
        font-size: 1.2em;
        font-weight: bold;
        background: #444;
        color: #fff;
        padding: 2px 8px;
        border-radius: 5px;
    }

    .status-PENDING {
        border-top: 3px solid #ffc107;
    }

    .status-APPROVED {
        border-top: 3px solid #28a745;
    }

    .status-IN_FLEET {
        border-top: 3px solid #3b5998;
    }

    .column-header.status-OVERVIEW {
        border-top: 3px solid #3b98d9; /* EVE Blue */
    }

    .fleet-ship-counts {
        /* This is now the main container */
        background: #2a2a2a;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px; /* Spacing between grid items */
    }

    .ship-count-category-block {
        min-width: 0; /* Prevents overflow issues */
    }

    .ship-count-category {
        font-size: 1.0em;
        font-weight: bold;
        color: #fff;
        margin: 0 0 4px 0; /* Removed top margin */
        padding-bottom: 3px;
        border-bottom: 1px solid #444;
    }

    .ship-count-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .ship-count-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9em;
        color: #ccc;
    }

        .ship-count-item img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .ship-count-item span {
            flex-grow: 1; /* Pushes count to the right */
            /* --- NEW: Truncate long ship names --- */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ship-count-item strong {
            color: #fff;
            font-size: 1.1em;
        }

    .fleet-structure-overview {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em; /* Smaller font */
        flex-grow: 1;
        overflow-y: auto;
        background: #2a2a2a;
        padding: 8px;
        border-radius: 8px;
    }

        .fleet-structure-overview::-webkit-scrollbar {
            width: 8px;
        }

        .fleet-structure-overview::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.5);
            border-radius: 4px;
        }

        .fleet-structure-overview::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

            .fleet-structure-overview::-webkit-scrollbar-thumb:hover {
                background: #666;
            }

    .overview-fleet-command {
        margin-bottom: 8px;
        background: #3a3a3a;
        padding: 5px 8px;
        border-radius: 5px;
    }

    .overview-fc-header {
        font-size: 1.0em;
        font-weight: bold;
        color: #fff;
        margin-bottom: 4px;
        border-bottom: 1px solid #555;
        padding-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .overview-fc-star {
        color: #999;
        font-size: 1.2em;
    }

    .overview-fc-member {
        list-style: none;
        padding: 0 0 0 5px; /* Indent slightly */
        margin: 0;
        color: #3b98d9; /* EVE Blue */
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-member-ship {
        color: #aaa;
        font-style: italic;
        margin-left: 5px;
    }

    .overview-wing {
        margin-bottom: 8px;
    }

    .overview-wing-header {
        font-size: 1.0em; /* Smaller */
        font-weight: bold;
        color: #fff;
        margin-bottom: 4px;
    }

    .overview-squad {
        margin-bottom: 4px;
    }

    .overview-squad-header {
        font-size: 0.95em; /* Smaller */
        font-weight: bold;
        color: #ddd;
    }

    .overview-member-list {
        list-style: none;
        padding-left: 5px; /* --- MODIFIED: Minimal indent for list --- */
        margin: 0;
    }

    .overview-wc { /* Wing Commander */
        padding-left: 15px;
        color: #3b98d9;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-squad-header {
        padding-left: 15px;
    }

    .overview-sc { /* Squad Commander */
        padding-left: 30px;
        color: #3b98d9;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-member { /* Squad Member */
        padding: 1px 0 1px 45px;
        color: #aaa; /* Members are dimmer */
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .fit-card-list {
        list-style: none;
        padding: 5px; /* MODIFIED: Was 8px */
        margin: 0;
        overflow-y: auto;
        height: 100%;
    }

        .fit-card-list::-webkit-scrollbar {
            width: 8px;
        }

        .fit-card-list::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.5); /* MODIFIED: Made track semi-transparent */
            border-radius: 4px;
        }

        .fit-card-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

            .fit-card-list::-webkit-scrollbar-thumb:hover {
                background: #666;
            }


    .fit-card {
        background: #333; /* MODIFIED: Re-added background */
        border: 0px solid #444; /* MODIFIED: Re-added border */
        border-radius: 5px;
        margin-bottom: 5px; /* MODIFIED: Was 8px */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* MODIFIED: Re-added shadow */
        transition: opacity 0.5s ease;
    }

        .fit-card.status-IN_FLEET {
            opacity: 0.4; /* Fade out invited pilots */
        }

    .card-header {
        display: flex;
        align-items: center;
        gap: 8px; /* MODIFIED: Was 10px */
        padding: 6px; /* MODIFIED: Was 8px */
        border-bottom: 0px solid #444;
    }

    .pilot-portrait {
        width: 40px; /* MODIFIED: Was 48px */
        height: 40px; /* MODIFIED: Was 48px */
        border-radius: 5px;
        border: 0px solid #555;
    }

    .pilot-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #fff;
        /* Prevent long names from breaking layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .wait-timer {
        font-size: 0.8em;
        font-weight: bold;
        color: #ffc107; /* Yellow */
        margin-left: auto;
        padding: 2px 6px;
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
    }

    .fit-card.status-IN_FLEET .wait-timer {
        color: #63d471; /* Green */
    }

    .card-body {
        padding: 6px; /* MODIFIED: Was 8px */
        font-size: 0.9em;
    }

    .card-body-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .card-fit-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Take up available space */
        min-width: 0; /* Allow shrinking */
    }

    .ship-image-container {
        flex-shrink: 0; /* Don't shrink */
        cursor: pointer;
        border-radius: 5px;
        padding: 4px;
        transition: background-color 0.2s;
    }

        .ship-image-container:hover {
            background-color: #444;
        }

        .ship-image-container img {
            width: 56px; /* MODIFIED: Was 64px */
            height: 56px; /* MODIFIED: Was 64px */
            display: block; /* Remove bottom space */
        }

    .fit-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        justify-content: flex-start;
        gap: 5px;
    }

        .fit-info strong {
            color: #aaa;
            flex-shrink: 0;
        }

        .fit-info .placeholder {
            color: #ddd;
            font-weight: 500;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }

    .fit-issues {
        margin-top: 8px;
        font-size: 0.85em;
    }

        .fit-issues strong {
            color: #ffc107;
        }

        .fit-issues .placeholder {
            color: #ffc107;
        }

    .pilot-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 0px solid #444;
        display: flex;
        justify-content: space-around;
        font-size: 0.8em;
    }

    .stat-item {
        text-align: center;
    }

        .stat-item strong {
            color: #aaa;
        }

        .stat-item .placeholder {
            color: #ddd;
            font-weight: 600;
        }

    .fc-actions {
        display: flex;
        gap: 5px;
        border-top: 0px solid #444;
        padding: 6px 8px 4px 8px;
        margin-top: 8px;
        justify-content: flex-end;
    }

    .fc-btn {
        background: #555;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        padding: 5px 8px;
        font-size: 1.1em;
        line-height: 1;
        transition: background-color 0.2s, transform 0.1s;
    }

        .fc-btn:hover {
            transform: scale(1.1);
        }

        .fc-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    .btn-approve {
        background-color: #28a745;
    }

        .btn-approve:hover {
            background-color: #34c254;
        }

    .btn-deny {
        background-color: #dc3545;
    }

        .btn-deny:hover {
            background-color: #e64a58;
        }

    .btn-invite {
        background-color: #3b5998;
        font-size: 0.9em; /* Make text fit */
        padding: 6px 8px; /* Adjust padding */
    }

        .btn-invite:hover {
            background-color: #4e71bb;
        }


    .waitlist-closed-msg {
        color: #aaa;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="waitlist-container" id="waitlist-container-live">
    {% include "_waitlist_columns.html" %}
    {% if is_fc and open_waitlist %}
    <div class="waitlist-column" id="fleet-overview-column">
        <div class="column-header status-OVERVIEW">
            <h2>Fleet Overview</h2>
        </div>
        <div class="fleet-ship-counts" id="fleet-ship-counts-container">
            <p style="color: #888; font-size: 0.85em; margin: 0;">Loading ship counts...</p>
        </div>
        <div class="fleet-structure-overview" id="fleet-structure-overview-body">
            <p style="color: #888; font-size: 0.85em; margin: 0;">Loading fleet members...</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // This script block will handle both FC actions and the new timer/polling
    // --- CSRF Token for all API requests ---
    const csrfToken = "{{ csrf_token }}";
    // --- Check if user is an FC ---
    const isFC = {{ is_fc|yesno:"true,false" }};
    const currentUserID = {{ request.user.id }};

    // --- 1. FC ACTION HANDLER (Approve/Deny) ---

    function handleFCAction(event) {
        // Find the button that was clicked
        const button = event.target.closest('.fc-btn');
        if (!button) return; // Click wasn't on a button

        if (button.classList.contains('btn-invite')) {
            return;
        }

        const fitId = button.dataset.fitId;
        const action = button.dataset.action;
        const card = document.getElementById(`fit-card-${fitId}`);

        // Disable all buttons on this card to prevent double-clicks
        if (card) {
            card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = true);
        }

        const formData = new FormData();
        formData.append('fit_id', fitId);
        formData.append('action', action);

        fetch("{% url 'waitlist:api_update_fit_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Let the poller handle moving 'approved' fits
                if (action === 'deny') {
                    if (card) {
                        card.remove();
                    }
                } else {
                    // Optional: show a temporary "approved" state
                    // For now, we just leave buttons disabled
                }

            } else {
                // Re-enable buttons on failure
                if (card) {
                    card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
                }
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            // Re-enable buttons on failure
            if (card) {
                card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
            }
            alert(`Network Error: ${error.message}`);
        });
    }

    function handleFCInvite(event) {
        const button = event.target.closest('.btn-invite');
        if (!button) return; // Not an invite button

        const fitId = button.dataset.fitId;
        const card = document.getElementById(`fit-card-${fitId}`);

        button.disabled = true;
        button.textContent = '...'; // Show loading

        const formData = new FormData();
        formData.append('fit_id', fitId);

        fetch("{% url 'waitlist:api_fc_invite_pilot' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (card) {
                    card.classList.add('status-IN_FLEET');
                }

            } else {
                // Show a pop-up on error
                // We can use our new custom confirm modal as an alert
                showCustomConfirm(
                    `<strong>Invite Failed</strong><br>${data.message}`,
                    () => {} // Pass an empty function
                );
                button.disabled = false;
                button.textContent = 'Invite';
            }
        })
        .catch(err => {
            showCustomConfirm(
                `<strong>Network Error</strong><br>${err.message}`,
                () => {}
            );
            button.disabled = false;
            button.textContent = 'Invite';
        });
    }
    // --- 2. TIMER AND LIVE POLLING ---

    const waitlistContainer = document.getElementById('waitlist-container-live');
    let timerInterval = null;

    // This function updates all timers on the page
    function updateWaitTimers() {
        const fitCards = waitlistContainer.querySelectorAll('.fit-card');
        const now = new Date();

        fitCards.forEach(card => {
            const timerEl = card.querySelector('.wait-timer');
            const submittedTime = new Date(card.dataset.submittedTime);

            const diffMs = now - submittedTime;
            const diffMins = Math.floor(diffMs / 60000); // Total minutes

            if (timerEl) {
                timerEl.textContent = `${diffMins}m`;
            }
        });
    }

    // This function fetches the new HTML
    function fetchWaitlistHTML() {
        console.log("Fetching new waitlist HTML...");
        fetch("{% url 'waitlist:api_get_waitlist_html' %}")
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Waitlist closed or error');
            })
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const columnsToReplace = [
                    '.status-PENDING', '.status-APPROVED', /* Add other column selectors if needed */
                ];

                // Find all columns in the live DOM
                const liveColumns = waitlistContainer.querySelectorAll('.waitlist-column');
                // Find all columns in the new HTML
                const newColumns = tempDiv.querySelectorAll('.waitlist-column');
                // Remove old columns
                liveColumns.forEach(col => {
                    if (col.id !== 'fleet-overview-column') {
                        col.remove();
                    }
                });

                // Add new columns before the overview column
                const overviewColumn = document.getElementById('fleet-overview-column');
                newColumns.forEach(newCol => {
                    if (overviewColumn) {
                        waitlistContainer.insertBefore(newCol, overviewColumn);
                    } else {
                        waitlistContainer.appendChild(newCol);
                    }
                });
                // After redrawing, re-update the timers immediately
                updateWaitTimers();
            })
            .catch(error => {
                // Waitlist is probably closed
                waitlistContainer.innerHTML = `<p class="waitlist-closed-msg">Waitlist is currently closed. The page will refresh when it opens.</p>`;
            });
    }

    // --- 3. NEW: FIT DETAIL MODAL HANDLER ---
    const fitModalOverlay = document.getElementById('fit-detail-modal-overlay');
    const fitModalCloseBtn = document.getElementById('fit-detail-modal-close-btn');
    const fitModalCancelBtn = document.getElementById('fit-detail-modal-cancel-btn');
    const fitModalBody = document.getElementById('fit-detail-modal-body');
    const fitModalTitle = document.getElementById('fit-detail-modal-title');

    const fitModalAcceptBtn = document.getElementById('fit-detail-modal-accept-btn');
    const fitModalDenyBtn = document.getElementById('fit-detail-modal-deny-btn');
    const fitModalUpdateBtn = document.getElementById('fit-detail-modal-update-btn');

    let currentModalFitId = null;

    function buildSlottedFitHtml(data) {
        const fit = data.slotted_fit;
        if (!fit || !fit.ship || !fit.slots) {
            return '<p style="color: #ff8a8a; padding: 20px;">Error: Invalid fit data received.</p>';
        }

        let html = '<div class="fit-modal-layout">';
        html += '<div class="fit-modal-slot-banks">';

        const slotOrder = ['high', 'mid', 'low', 'rig', 'subsystem', 'drone', 'cargo'];
        const slotNames = {
            high: 'High Slots', mid: 'Mid Slots', low: 'Low Slots',
            rig: 'Rig Slots', subsystem: 'Subsystem Slots',
            drone: 'Drones', cargo: 'Cargo Hold'
        };

        slotOrder.forEach(slotKey => {
            const items = fit.slots[slotKey];
            const count = fit.slot_counts[slotKey] || 0;

            if (!items || items.length === 0) {
                return; // Don't render empty sections
            }

            html += '<div class="fit-slot-bank">';
            html += '<div class="fit-slot-bank-header">';
            html += `${slotNames[slotKey]} `;

            if (!fit.is_t3c && slotKey !== 'drone' && slotKey !== 'cargo') {
                 const fitted_count = items.filter(i => !i.is_empty).length;
                 html += `<span>(${fitted_count} / ${count})</span>`;
            }
            html += '</div>';

            html += '<ul class="fit-slot-list">';
            items.forEach(item => {
                let itemClass = item.is_empty ? 'is-empty' : '';

                html += `<li class="fit-slot-item ${itemClass}" title="${item.name}">`;

                if (item.is_empty) {
                    html += `<img src="https://images.evetech.net/types/2965/icon?size=32" alt="Empty Slot" class="fit-modal-icon" style="opacity: 0.2;">`;
                    html += `<span class="fit-item-name">${item.name}</span>`;
                } else {
                    const icon_url = item.icon_url || `https://images.evetech.net/types/${item.type_id}/icon?size=32`;
                    html += `<img src="${icon_url}" alt="${item.name}" class="fit-modal-icon">`;
                    const line_text = item.raw_line || item.name;
                    const safe_line = line_text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    html += `<span class="fit-item-name">${safe_line}</span>`;
                }

                html += '</li>';
            });
            html += '</ul></div>'; // Close bank
        });

        html += '</div>'; // Close slot-banks
        html += '</div>'; // Close fit-modal-layout
        return html;
    }

    function openFitModal(fitId) {
        if (!fitModalOverlay) return;

        currentModalFitId = fitId;
        if(fitModalAcceptBtn) fitModalAcceptBtn.style.display = 'none';
        if(fitModalDenyBtn) fitModalDenyBtn.style.display = 'none';
        if(fitModalUpdateBtn) fitModalUpdateBtn.style.display = 'none';

        if(fitModalAcceptBtn) fitModalAcceptBtn.disabled = false;
        if(fitModalDenyBtn) fitModalDenyBtn.disabled = false;
        if(fitModalUpdateBtn) fitModalUpdateBtn.disabled = false;

        fitModalBody.innerHTML = '<div class="modal-spinner"></div>';
        fitModalTitle.textContent = "Loading Fit...";
        fitModalOverlay.classList.add('show');

        fetch(`{% url 'waitlist:api_get_fit_details' %}?fit_id=${fitId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load fit details.');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load fit.');
                }

                fitModalTitle.textContent = data.name;
                fitModalBody.innerHTML = buildSlottedFitHtml(data);

                const userIsOwner = (data.character_user_id === currentUserID);

                if (isFC) {
                    fitModalAcceptBtn.style.display = 'inline-block';
                    fitModalDenyBtn.style.display = 'inline-block';
                } else if (userIsOwner) {
                    fitModalUpdateBtn.style.display = 'inline-block';
                    fitModalUpdateBtn.dataset.rawFit = data.raw_fit;
                    fitModalUpdateBtn.dataset.characterId = data.character_id;
                }
            })
            .catch(error => {
                fitModalBody.innerHTML = `<p style="color: #ff8a8a; padding: 20px;">Error: ${error.message}</p>`;
            });
    }

    function closeFitModal() {
        if (fitModalOverlay) {
            fitModalOverlay.classList.remove('show');

            currentModalFitId = null;
            if(fitModalAcceptBtn) fitModalAcceptBtn.style.display = 'none';
            if(fitModalDenyBtn) fitModalDenyBtn.style.display = 'none';
            if(fitModalUpdateBtn) fitModalUpdateBtn.style.display = 'none';

            if(fitModalAcceptBtn) fitModalAcceptBtn.disabled = false;
            if(fitModalDenyBtn) fitModalDenyBtn.disabled = false;
            if(fitModalUpdateBtn) fitModalUpdateBtn.disabled = false;
        }
    }

    function handleUpdateFitClick(event) {
        const button = event.target;
        const rawFit = button.dataset.rawFit;
        const characterId = button.dataset.characterId;

        const xupModalOverlay = document.getElementById('xup-modal-overlay');
        const xupCharSelect = document.getElementById('xup-char-select');
        const xupFitTextarea = document.getElementById('xup-fit-textarea');
        const xupImplantContainer = document.getElementById('xup-implant-container');

        if (!xupModalOverlay || !xupCharSelect || !xupFitTextarea) {
            console.error("X-Up modal elements not found!");
            return;
        }

        closeFitModal();

        xupCharSelect.value = characterId;
        xupFitTextarea.value = rawFit;

        xupImplantContainer.innerHTML = '<div class="implant-spinner"></div>';
        fetch(`{% url 'pilot:api_get_implants' %}?character_id=${characterId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    xupImplantContainer.innerHTML = data.html;
                    startESITimer(data.expires_iso); // This function is in base.html
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                xupImplantContainer.innerHTML = `<p style="color: #ff8a8a;">Error: ${error.message}</p>`;
            });

        xupModalOverlay.classList.add('show');
    }

    // Add close listeners for the modal
    if (fitModalOverlay) {
        fitModalCloseBtn.addEventListener('click', closeFitModal);
        fitModalCancelBtn.addEventListener('click', closeFitModal);
        fitModalOverlay.addEventListener('click', (e) => {
            if (e.target === fitModalOverlay) {
                closeFitModal();
            }
        });
    }


    // This function sets up all our event listeners
    function initializeWaitlist() {

        if (isFC) {
            if(fitModalAcceptBtn) fitModalAcceptBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'approve'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal();
                }
            });

            if(fitModalDenyBtn) fitModalDenyBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'deny'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal();
                }
            });
        }
        if(fitModalUpdateBtn) {
            fitModalUpdateBtn.addEventListener('click', handleUpdateFitClick);
        }

        waitlistContainer.addEventListener('click', (event) => {
            const fcButton = event.target.closest('.fc-btn');
            if (isFC && fcButton) {
                if (fcButton.classList.contains('btn-invite')) {
                    handleFCInvite(event);
                } else {
                    handleFCAction(event);
                }
                return;
            }

            const fitModalButton = event.target.closest('.js-open-fit-modal');
            if (fitModalButton) {
                const fitId = fitModalButton.dataset.fitId;
                openFitModal(fitId);
                return;
            }
        });

        updateWaitTimers();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateWaitTimers, 10000);
    }

    // --- 5. PAGE INITIALIZATION ---

    document.addEventListener('DOMContentLoaded', () => {
        const xupButton = document.getElementById('xup-modal-button');
        const openWaitlist = {{ open_waitlist.pk|default:"null" }};

        if (xupButton && openWaitlist !== null) {
            xupButton.disabled = false;
        }

        initializeWaitlist();

        if (isFC && openWaitlist !== null) {
            startFleetOverviewPolling();
        }

        console.log("Connecting to event stream /events/waitlist-updates/...");

        const eventSource = new EventSource("/events/?channel=waitlist-updates");

        eventSource.addEventListener('update', (event) => {
            console.log("Received 'update' event from server:", event.data);
            fetchWaitlistHTML();

            try {
                const data = JSON.parse(event.data);
                if (data.action === 'close') {
                    console.log("Waitlist closed event received, stopping overview polling.");
                    stopFleetOverviewPolling();
                    window.location.reload();
                }
            } catch (e) {
            }
        });

        eventSource.onopen = (event) => {
            console.log("EventSource connection opened.");
        };

        eventSource.onerror = (event) => {
            console.error("EventSource error:", event);
        };
    });
    let fleetOverviewInterval = null;
    const overviewSection = document.getElementById('fleet-overview-column');
    const overviewCountsContainer = document.getElementById('fleet-ship-counts-container');
    const overviewBody = document.getElementById('fleet-structure-overview-body');

    function loadFleetOverview(showOverlay = false) {
        if (!overviewSection) {
            stopFleetOverviewPolling();
            return;
        }

        if (showOverlay) {
            overviewCountsContainer.innerHTML = `<p style="color: #888; font-size: 0.85em; margin: 0;">Refreshing...</p>`;
            overviewBody.innerHTML = `<p style="color: #888; font-size: 0.85em; margin: 0;">Refreshing...</p>`;
        }

        fetch("{% url 'waitlist:api_get_fleet_members' %}")
            .then(response => {
                if (response.status === 404) {
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">ESI fleet not found. Polling stopped.</p>`;
                    overviewCountsContainer.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Fleet Not Found</p>`;
                    stopFleetOverviewPolling();
                    throw new Error('Fleet not found');
                }
                if (!response.ok) {
                    throw new Error('Network error');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const counts_list = data.detailed_ship_counts;
                    let countsHtml = '';

                    const buildCategoryHtml = (categoryName, ships) => {
                        if (!ships || ships.length === 0) {
                            return '';
                        }
                        let html = `<div class="ship-count-category-block">`;
                        html += `<div class="ship-count-category">${categoryName}</div>`;
                        html += `<ul class="ship-count-list">`;
                        ships.forEach(ship => {
                            html += `<li class="ship-count-item" title="${ship.name}">
                                        <img src="https://images.evetech.net/types/${ship.type_id}/icon?size=32" alt="${ship.name}">
                                        <span>${ship.name}</span>
                                        <strong>${ship.count}</strong>
                                     </li>`;
                        });
                        html += `</ul></div>`;
                        return html;
                    };

                    if (counts_list && counts_list.length > 0) {
                        counts_list.forEach(category_data => {
                            countsHtml += buildCategoryHtml(category_data.name, category_data.ships);
                        });
                    }

                    if (countsHtml === '') {
                        countsHtml = '<p style="color: #888; font-size: 0.85em; margin: 0; grid-column: 1 / -1;">No tracked ships in fleet.</p>';
                    }

                    overviewCountsContainer.innerHTML = countsHtml;

                    let structureHtml = '';

                    structureHtml += `<div class="overview-fleet-command">`;
                    structureHtml += `<div class="overview-fc-header">
                                        <span>${data.fleet_boss_name} (${data.total_member_count})</span>
                                        <span class="overview-fc-star">★</span>
                                    </div>`;

                    if (data.fleet_commander) {
                        const fc = data.fleet_commander;
                        structureHtml += `<div class="overview-fc-member" title="${fc.character_name} (${fc.ship_name})">${fc.character_name} <span class="overview-member-ship">(${fc.ship_name})</span></div>`;
                    }
                    structureHtml += `</div>`;

                    if (data.wings.length > 0) {
                        data.wings.forEach(wing => {
                            structureHtml += `<div class="overview-wing">`;
                            structureHtml += `<div class="overview-wing-header" title="${wing.name}">${wing.name} (${wing.member_count})</div>`;

                            if (wing.wing_commander) {
                                const wc = wing.wing_commander;
                                structureHtml += `<div class="overview-wc" title="${wc.character_name} (${wc.ship_name})">${wc.character_name} <span class="overview-member-ship">(${wc.ship_name})</span></div>`;
                            }

                            wing.squads.forEach(squad => {
                                structureHtml += `<div class="overview-squad">`;
                                structureHtml += `<div class="overview-squad-header" title="${squad.name}">${squad.name} (${squad.member_count})</div>`;

                                if (squad.squad_commander) {
                                    const sc = squad.squad_commander;
                                    structureHtml += `<div class="overview-sc" title="${sc.character_name} (${sc.ship_name})">${sc.character_name} <span class="overview-member-ship">(${sc.ship_name})</span></div>`;
                                }

                                if (squad.members.length > 0) {
                                    structureHtml += `<ul class="overview-member-list">`;
                                    squad.members.forEach(member => {
                                        structureHtml += `<li class="overview-member" title="${member.character_name} (${member.ship_name})">${member.character_name} <span class="overview-member-ship">(${member.ship_name})</span></li>`;
                                    });
                                    structureHtml += `</ul>`;
                                }
                                structureHtml += `</div>`;
                            });
                            structureHtml += `</div>`;
                        });
                    } else if (!data.fleet_commander) {
                        structureHtml += '<p style="color: #888; font-size: 0.85em; margin: 0;">Fleet is empty.</p>';
                    }

                    overviewBody.innerHTML = structureHtml;

                } else {
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Error: ${data.message}</p>`;
                    overviewCountsContainer.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Error</p>`;
                }
            })
            .catch(err => {
                if (err.message !== 'Fleet not found') {
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Network Error: ${err.message}</p>`;
                }
            });
    }

    function startFleetOverviewPolling() {
        stopFleetOverviewPolling();
        console.log("Starting fleet overview polling (5s)...");
        loadFleetOverview(true);
        fleetOverviewInterval = setInterval(() => loadFleetOverview(false), 5000);
    }

    function stopFleetOverviewPolling() {
        if (fleetOverviewInterval) {
            console.log("Stopping fleet overview polling.");
            clearInterval(fleetOverviewInterval);
            fleetOverviewInterval = null;
        }
    }
</script>
{% endblock %}