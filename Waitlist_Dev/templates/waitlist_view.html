{% extends "base.html" %}
{% load humanize %}

<!-- This sets the page title -->
{% block title %}EVE Waitlist - View{% endblock %}


<!-- These styles are specific to the waitlist view -->
{% block styles %}
<style>
    .waitlist-container {
        display: flex;
        flex-direction: row;
        gap: 10px;
        padding: 10px;
        /* Allow horizontal scrolling on small screens */
        overflow-x: auto;
        /* Set a height so vertical scrollbars appear inside columns */
        height: calc(100vh - var(--header-height) - 20px); /* Full height minus header */
    }

    .waitlist-column {
        flex: 1 0 280px; /* MODIFIED: Was 300px */
        min-width: 280px; /* MODIFIED: Was 300px */
        max-width: 320px; /* MODIFIED: Was 340px */
        display: flex;
        flex-direction: column;
        background: none; /* MODIFIED: Removed column background */
        border-radius: 8px;
        /* Handle vertical overflow */
        height: 100%;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 2px solid #444;
    }

        .column-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: #fff;
        }

    .column-count {
        font-size: 1.2em;
        font-weight: bold;
        background: #444;
        color: #fff;
        padding: 2px 8px;
        border-radius: 5px;
    }

    /* Column Header Colors */
    .status-PENDING {
        border-top: 3px solid #ffc107;
    }

    .status-APPROVED {
        border-top: 3px solid #28a745;
    }

    /* --- NEW: In Fleet Status --- */
    .status-IN_FLEET {
        border-top: 3px solid #3b5998;
    }

    /* --- NEW: Fleet Overview Column Styles (from fc_admin.html) --- */
    .column-header.status-OVERVIEW {
        border-top: 3px solid #3b98d9; /* EVE Blue */
    }

    /* ---
    --- NEW: Detailed Ship Count Styles
    --- */
    .fleet-ship-counts {
        /* This is now the main container */
        background: #2a2a2a;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        /* --- NEW: Use CSS Grid for 2x2 layout --- */
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px; /* Spacing between grid items */
    }

    .ship-count-category-block {
        /* This is the new wrapper for a category */
        min-width: 0; /* Prevents overflow issues */
    }

    .ship-count-category {
        font-size: 1.0em;
        font-weight: bold;
        color: #fff;
        margin: 0 0 4px 0; /* Removed top margin */
        padding-bottom: 3px;
        border-bottom: 1px solid #444;
    }

    .ship-count-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .ship-count-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9em;
        color: #ccc;
    }

        .ship-count-item img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .ship-count-item span {
            flex-grow: 1; /* Pushes count to the right */
            /* --- NEW: Truncate long ship names --- */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ship-count-item strong {
            color: #fff;
            font-size: 1.1em;
        }
    /* ---
    --- END NEW Detailed Ship Count Styles
    --- */

    .fleet-structure-overview {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em; /* Smaller font */
        /* Let it fill the available space */
        flex-grow: 1;
        overflow-y: auto;
        background: #2a2a2a;
        padding: 8px;
        border-radius: 8px;
        /* Scrollbar styling */
    }

        .fleet-structure-overview::-webkit-scrollbar {
            width: 8px;
        }

        .fleet-structure-overview::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.5);
            border-radius: 4px;
        }

        .fleet-structure-overview::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

            .fleet-structure-overview::-webkit-scrollbar-thumb:hover {
                background: #666;
            }

    /* --- NEW: FC SECTION --- */
    .overview-fleet-command {
        margin-bottom: 8px;
        background: #3a3a3a;
        padding: 5px 8px;
        border-radius: 5px;
    }

    .overview-fc-header {
        font-size: 1.0em;
        font-weight: bold;
        color: #fff;
        margin-bottom: 4px;
        border-bottom: 1px solid #555;
        padding-bottom: 4px;
        /* --- NEW: Flex for star --- */
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* --- NEW: Gray star --- */
    .overview-fc-star {
        color: #999;
        font-size: 1.2em;
    }

    .overview-fc-member {
        list-style: none;
        padding: 0 0 0 5px; /* Indent slightly */
        margin: 0;
        /* --- NEW: Add color --- */
        color: #3b98d9; /* EVE Blue */
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* --- END NEW --- */

    /* --- NEW: Ship name in overview --- */
    .overview-member-ship {
        color: #aaa;
        font-style: italic;
        margin-left: 5px;
    }
    /* --- END NEW --- */

    .overview-wing {
        margin-bottom: 8px;
    }

    .overview-wing-header {
        font-size: 1.0em; /* Smaller */
        font-weight: bold;
        color: #fff;
        margin-bottom: 4px;
    }

    .overview-squad {
        /* remove default indent */
        margin-bottom: 4px;
    }

    .overview-squad-header {
        font-size: 0.95em; /* Smaller */
        font-weight: bold;
        color: #ddd;
    }

    .overview-member-list {
        list-style: none;
        padding-left: 5px; /* --- MODIFIED: Minimal indent for list --- */
        margin: 0;
    }

    /* --- NEW: Indentation classes --- */
    .overview-wc { /* Wing Commander */
        padding-left: 15px;
        color: #3b98d9;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-squad-header {
        padding-left: 15px;
    }

    .overview-sc { /* Squad Commander */
        padding-left: 30px;
        color: #3b98d9;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-member { /* Squad Member */
        padding: 1px 0 1px 45px;
        color: #aaa; /* Members are dimmer */
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* --- END NEW --- */


    .fit-card-list {
        list-style: none;
        padding: 5px; /* MODIFIED: Was 8px */
        margin: 0;
        /* Make the list scrollable, not the whole column */
        overflow-y: auto;
        height: 100%;
    }

        /* Scrollbar styling */
        .fit-card-list::-webkit-scrollbar {
            width: 8px;
        }

        .fit-card-list::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.5); /* MODIFIED: Made track semi-transparent */
            border-radius: 4px;
        }

        .fit-card-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

            .fit-card-list::-webkit-scrollbar-thumb:hover {
                background: #666;
            }


    .fit-card {
        background: #333; /* MODIFIED: Re-added background */
        border: 0px solid #444; /* MODIFIED: Re-added border */
        border-radius: 5px;
        margin-bottom: 5px; /* MODIFIED: Was 8px */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* MODIFIED: Re-added shadow */
        /* --- NEW: Transition for invite --- */
        transition: opacity 0.5s ease;
    }

        .fit-card.status-IN_FLEET {
            opacity: 0.4; /* Fade out invited pilots */
        }

    .card-header {
        display: flex;
        align-items: center;
        gap: 8px; /* MODIFIED: Was 10px */
        padding: 6px; /* MODIFIED: Was 8px */
        border-bottom: 0px solid #444;
    }

    .pilot-portrait {
        width: 40px; /* MODIFIED: Was 48px */
        height: 40px; /* MODIFIED: Was 48px */
        border-radius: 5px;
        border: 0px solid #555;
    }

    .pilot-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #fff;
        /* Prevent long names from breaking layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- NEW: Wait Timer Style --- */
    .wait-timer {
        font-size: 0.8em;
        font-weight: bold;
        color: #ffc107; /* Yellow */
        margin-left: auto;
        padding: 2px 6px;
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
    }

    /* --- NEW: In Fleet Timer Style --- */
    .fit-card.status-IN_FLEET .wait-timer {
        color: #63d471; /* Green */
    }

    .card-body {
        padding: 6px; /* MODIFIED: Was 8px */
        font-size: 0.9em;
    }

    /* --- NEW: Layout for fit info + ship image --- */
    .card-body-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .card-fit-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Take up available space */
        min-width: 0; /* Allow shrinking */
    }

    .ship-image-container {
        flex-shrink: 0; /* Don't shrink */
        /* --- NEW: Add cursor for clickable --- */
        cursor: pointer;
        border-radius: 5px;
        padding: 4px;
        transition: background-color 0.2s;
    }

        .ship-image-container:hover {
            background-color: #444;
        }

        .ship-image-container img {
            width: 56px; /* MODIFIED: Was 64px */
            height: 56px; /* MODIFIED: Was 64px */
            display: block; /* Remove bottom space */
        }
    /* --- END NEW --- */


    .fit-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        /* --- MODIFIED: Justify left --- */
        justify-content: flex-start;
        gap: 5px;
    }

        .fit-info strong {
            color: #aaa;
            flex-shrink: 0;
        }

        .fit-info .placeholder {
            color: #ddd;
            font-weight: 500;
            /* --- Allow text to wrap --- */
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            /* --- Justify left --- */
            text-align: left;
        }

    .fit-issues {
        margin-top: 8px;
        font-size: 0.85em;
    }

        .fit-issues strong {
            color: #ffc107;
        }
        /* Yellow */
        .fit-issues .placeholder {
            color: #ffc107;
        }

    .pilot-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 0px solid #444;
        display: flex;
        justify-content: space-around;
        font-size: 0.8em;
    }

    .stat-item {
        text-align: center;
    }

        .stat-item strong {
            color: #aaa;
        }

        .stat-item .placeholder {
            color: #ddd;
            font-weight: 600;
        }

    /* --- NEW: FC Action Bar --- */
    .fc-actions {
        display: flex;
        gap: 5px;
        border-top: 0px solid #444;
        padding: 6px 8px 4px 8px; /* MODIFIED: Was 8px 10px 5px 10px */
        margin-top: 8px; /* MODIFIED: Was 10px */
        /* --- MODIFIED: Align buttons to the right --- */
        justify-content: flex-end;
    }

    .fc-btn {
        background: #555;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        padding: 5px 8px;
        /* --- MODIFIED: Slightly larger emoji --- */
        font-size: 1.1em;
        line-height: 1;
        transition: background-color 0.2s, transform 0.1s;
    }

        .fc-btn:hover {
            transform: scale(1.1);
        }

        .fc-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    .btn-approve {
        background-color: #28a745;
    }

        .btn-approve:hover {
            background-color: #34c254;
        }

    .btn-deny {
        background-color: #dc3545;
    }

        .btn-deny:hover {
            background-color: #e64a58;
        }

    /* --- NEW: Invite Button --- */
    .btn-invite {
        background-color: #3b5998;
        font-size: 0.9em; /* Make text fit */
        padding: 6px 8px; /* Adjust padding */
    }

        .btn-invite:hover {
            background-color: #4e71bb;
        }


    .waitlist-closed-msg {
        color: #aaa;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
</style>
{% endblock %}


{% block content %}
<!--
This container will be the target for our live polling.
It will be filled by the partial template on page load.
-->
<div class="waitlist-container" id="waitlist-container-live">
    {% include "_waitlist_columns.html" %}

    <!--
    ---
    --- NEW: FLEET OVERVIEW COLUMN
    ---
    -->
    {% if is_fc and open_waitlist %}
    <div class="waitlist-column" id="fleet-overview-column">
        <div class="column-header status-OVERVIEW">
            <h2>Fleet Overview</h2>
            <!-- Refresh button can be added here if needed -->
        </div>
        <!-- --- MODIFIED: Container for new detailed list --- -->
        <div class="fleet-ship-counts" id="fleet-ship-counts-container">
            <p style="color: #888; font-size: 0.85em; margin: 0;">Loading ship counts...</p>
        </div>
        <div class="fleet-structure-overview" id="fleet-structure-overview-body">
            <p style="color: #888; font-size: 0.85em; margin: 0;">Loading fleet members...</p>
        </div>
    </div>
    {% endif %}
    <!--
    ---
    --- END NEW FLEET OVERVIEW
    ---
    -->
</div>
{% endblock %}


<!-- --- NEW JAVASCRIPT BLOCK --- -->
{% block scripts %}
<script>
    // This script block will handle both FC actions and the new timer/polling

    // --- CSRF Token for all API requests ---
    const csrfToken = "{{ csrf_token }}";

    // --- Check if user is an FC ---
    const isFC = {{ is_fc|yesno:"true,false" }};

    // --- 1. FC ACTION HANDLER (Approve/Deny) ---

    function handleFCAction(event) {
        // Find the button that was clicked
        const button = event.target.closest('.fc-btn');
        if (!button) return; // Click wasn't on a button

        // --- MODIFICATION: Ignore invite buttons ---
        if (button.classList.contains('btn-invite')) {
            return;
        }
        // --- END MODIFICATION ---

        const fitId = button.dataset.fitId;
        const action = button.dataset.action;
        const card = document.getElementById(`fit-card-${fitId}`);

        // Disable all buttons on this card to prevent double-clicks
        if (card) {
            card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = true);
        }

        const formData = new FormData();
        formData.append('fit_id', fitId);
        formData.append('action', action);

        fetch("{% url 'waitlist:api_update_fit_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // --- FIX: Only remove on 'deny' ---
                // Let the poller handle moving 'approved' fits
                if (action === 'deny') {
                    if (card) {
                        card.remove();
                    }
                } else {
                    // Optional: show a temporary "approved" state
                    // For now, we just leave buttons disabled
                }
                // ---
                // --- NEW: Event is sent from the server, no need to do anything here
                // ---
            } else {
                // Re-enable buttons on failure
                if (card) {
                    card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
                }
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            // Re-enable buttons on failure
            if (card) {
                card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
            }
            alert(`Network Error: ${error.message}`);
        });
    }

    // ---
    // --- NEW: FC INVITE HANDLER
    // ---
    function handleFCInvite(event) {
        const button = event.target.closest('.btn-invite');
        if (!button) return; // Not an invite button

        const fitId = button.dataset.fitId;
        const card = document.getElementById(`fit-card-${fitId}`);

        button.disabled = true;
        button.textContent = '...'; // Show loading

        const formData = new FormData();
        formData.append('fit_id', fitId);

        fetch("{% url 'waitlist:api_fc_invite_pilot' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Success! Let the poller handle the removal.
                // We'll just fade out the card.
                if (card) {
                    card.classList.add('status-IN_FLEET');
                }
                // ---
                // --- NEW: Event is sent from the server, no need to do anything here
                // ---
            } else {
                // Show a pop-up on error
                // We can use our new custom confirm modal as an alert
                showCustomConfirm(
                    `<strong>Invite Failed</strong><br>${data.message}`,
                    () => {} // Pass an empty function
                );
                button.disabled = false;
                button.textContent = 'Invite';
            }
        })
        .catch(err => {
            showCustomConfirm(
                `<strong>Network Error</strong><br>${err.message}`,
                () => {}
            );
            button.disabled = false;
            button.textContent = 'Invite';
        });
    }
    // ---
    // --- END NEW INVITE HANDLER
    // ---

    // --- 2. TIMER AND LIVE POLLING ---

    const waitlistContainer = document.getElementById('waitlist-container-live');
    // ---
    // --- REMOVED: Polling interval is no longer needed
    // ---
    // let pollingInterval = null;
    let timerInterval = null;

    // This function updates all timers on the page
    function updateWaitTimers() {
        const fitCards = waitlistContainer.querySelectorAll('.fit-card');
        const now = new Date();

        fitCards.forEach(card => {
            const timerEl = card.querySelector('.wait-timer');
            const submittedTime = new Date(card.dataset.submittedTime);

            const diffMs = now - submittedTime;
            const diffMins = Math.floor(diffMs / 60000); // Total minutes

            if (timerEl) {
                timerEl.textContent = `${diffMins}m`;
            }
        });
    }

    // This function fetches the new HTML
    function fetchWaitlistHTML() {
        // ---
        // --- NEW: Add a console.log
        // ---
        console.log("Fetching new waitlist HTML...");
        // ---
        // --- END NEW
        // ---
        fetch("{% url 'waitlist:api_get_waitlist_html' %}")
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Waitlist closed or error');
            })
            .then(html => {
                // --- This is the key: replace the content ---
                // --- MODIFICATION: Only replace the columns, not the new overview card ---
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const columnsToReplace = [
                    '.status-PENDING', '.status-APPROVED', /* Add other column selectors if needed */
                ];

                // Find all columns in the live DOM
                const liveColumns = waitlistContainer.querySelectorAll('.waitlist-column');
                // Find all columns in the new HTML
                const newColumns = tempDiv.querySelectorAll('.waitlist-column');

                // This is a simple replacement. A more complex diff would be better
                // for performance, but this is more robust for now.
                // It replaces all columns *except* our new overview column.

                // Remove old columns
                liveColumns.forEach(col => {
                    if (col.id !== 'fleet-overview-column') {
                        col.remove();
                    }
                });

                // Add new columns before the overview column
                const overviewColumn = document.getElementById('fleet-overview-column');
                newColumns.forEach(newCol => {
                    if (overviewColumn) {
                        waitlistContainer.insertBefore(newCol, overviewColumn);
                    } else {
                        waitlistContainer.appendChild(newCol);
                    }
                });
                // --- END MODIFICATION ---

                // After redrawing, re-update the timers immediately
                updateWaitTimers();
            })
            .catch(error => {
                // Waitlist is probably closed
                waitlistContainer.innerHTML = `<p class="waitlist-closed-msg">Waitlist is currently closed. The page will refresh when it opens.</p>`;
            });
    }

    // --- 3. NEW: FIT DETAIL MODAL HANDLER ---

    // Get modal elements (they are in base.html)
    const fitModalOverlay = document.getElementById('fit-detail-modal-overlay');
    const fitModalCloseBtn = document.getElementById('fit-detail-modal-close-btn');
    const fitModalCancelBtn = document.getElementById('fit-detail-modal-cancel-btn');
    const fitModalBody = document.getElementById('fit-detail-modal-body');
    const fitModalTitle = document.getElementById('fit-detail-modal-title');

    // --- NEW: Get modal footer buttons ---
    const fitModalAcceptBtn = document.getElementById('fit-detail-modal-accept-btn');
    const fitModalDenyBtn = document.getElementById('fit-detail-modal-deny-btn');

    // --- NEW: Variable to store current fit ID ---
    let currentModalFitId = null;


    // ---
    // --- NEW: Complex HTML Builder for FC Modal (replaces simple one)
    // ---
    function buildSlottedFitHtml(data) {
        const fit = data.slotted_fit;
        if (!fit || !fit.ship || !fit.slots) {
            return '<p style="color: #ff8a8a; padding: 20px;">Error: Invalid fit data received.</p>';
        }

        let html = '<div class="fit-modal-layout">';

        // --- 1. Ship Render Column ---
        html += `<div class="fit-modal-ship-render">
                    <img src="${fit.ship.icon_url}" alt="${fit.ship.name}">
                    <span>${fit.ship.name}</span>
                 </div>`;

        // --- 2. Slot Banks Column ---
        html += '<div class="fit-modal-slot-banks">';

        const slotOrder = ['high', 'mid', 'low', 'rig', 'subsystem', 'drone', 'cargo'];
        const slotNames = {
            high: 'High Slots', mid: 'Mid Slots', low: 'Low Slots',
            rig: 'Rig Slots', subsystem: 'Subsystem Slots',
            drone: 'Drones', cargo: 'Cargo Hold'
        };

        slotOrder.forEach(slotKey => {
            const items = fit.slots[slotKey];
            const count = fit.slot_counts[slotKey] || 0;

            if (!items || items.length === 0) {
                return; // Don't render empty sections
            }

            // Build header
            html += '<div class="fit-slot-bank">';
            html += '<div class="fit-slot-bank-header">';
            html += `${slotNames[slotKey]} `;

            if (!fit.is_t3c && slotKey !== 'drone' && slotKey !== 'cargo') {
                 const fitted_count = items.filter(i => !i.is_empty).length;
                 html += `<span>(${fitted_count} / ${count})</span>`;
            }
            html += '</div>';

            // Build item list
            html += '<ul class="fit-slot-list">';
            items.forEach(item => {
                let itemClass = item.is_empty ? 'is-empty' : '';

                // Add status class (e.g., 'fit-item-problem')
                if (item.status) {
                    itemClass += ` fit-item-${item.status}`;
                }

                html += `<li class="fit-slot-item ${itemClass}" title="${item.name}">`;

                if (item.is_empty) {
                    html += `<img src="https://images.evetech.net/types/2965/icon?size=32" alt="Empty Slot" class="fit-modal-icon" style="opacity: 0.2;">`;
                    html += `<span class="fit-item-name">${item.name}</span>`;
                } else {
                    // --- *** THIS IS THE FIX: Check for icon_url *** ---
                    const icon_url = item.icon_url || `https://images.evetech.net/types/${item.type_id}/icon?size=32`;
                    html += `<img src="${icon_url}" alt="${item.name}" class="fit-modal-icon">`;
                    // --- *** END THE FIX *** ---
                    const line_text = item.raw_line || item.name;
                    const safe_line = line_text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    html += `<span class="fit-item-name">${safe_line}</span>`;
                }

                // --- THIS IS THE NEW PART FOR FC MODAL ---
                let buttonsHtml = '';
                let indentedListHtml = '';

                if (item.status === 'accepted_sub') {
                    if (item.substitutes_for && item.substitutes_for.length > 0) {
                        indentedListHtml = '<ul class="fit-item-sub-for-list">';
                        item.substitutes_for.forEach(match => {
                            indentedListHtml += `<li class="fit-item-sub-for-item">`;
                            indentedListHtml += `<img src="${match.icon_url}" alt="${match.name}">`;
                            indentedListHtml += `<span>Substitutes for: ${match.name} (x${match.quantity})</span>`;
                            indentedListHtml += `</li>`;
                        });
                        indentedListHtml += '</ul>';
                    }
                }
                else if (item.status === 'problem') {
                    // --- *** NEW: Check for failure_reasons *** ---
                    if (item.failure_reasons && item.failure_reasons.length > 0) {
                        indentedListHtml = '<ul class="fit-item-failure-list">'; // New class
                        item.failure_reasons.forEach(fail => {
                            indentedListHtml += `<li class="fit-item-failure-item">`; // New class
                            // Format numbers nicely
                            const subVal = parseFloat(fail.submitted_value).toLocaleString();
                            const docVal = parseFloat(fail.doctrine_value).toLocaleString();
                            indentedListHtml += `<span>&#9888; ${fail.attribute_name} (Fit: ${subVal}, Need: ${docVal})</span>`;
                            indentedListHtml += `</li>`;
                        });
                        indentedListHtml += '</ul>';
                    }
                    // --- *** END NEW *** ---
                    else if (item.potential_matches && item.potential_matches.length > 0) {
                        indentedListHtml = '<ul class="fit-item-missing-list">';
                        item.potential_matches.forEach(match => {
                            indentedListHtml += `<li class="fit-item-missing-item">`;
                            indentedListHtml += `<img src="${match.icon_url}" alt="${match.name}">`;
                            indentedListHtml += `<span>Missing: ${match.name} (x${match.quantity})</span>`;
                            indentedListHtml += `</li>`;
                        });
                        indentedListHtml += '</ul>';
                    } else {
                        indentedListHtml = `<span class="fit-item-problem-tag">(Wrong Item)</span>`;
                    }

                    // Add the "Make Sub" button if there's a potential match
                    if (item.potential_matches && item.potential_matches.length > 0) {
                        const match = item.potential_matches[0];
                        buttonsHtml = `<div class="sub-action-buttons">
                            <button class="fc-btn btn-approve js-sub-accept"
                                data-problem-item-id="${item.type_id}"
                                data-problem-item-name="${item.name}"
                                data-missing-item-id="${match.type_id}"
                                data-missing-item-name="${match.name}"
                                title="Accept ${item.name} as substitute for ${match.name}">&#10003;</button>
                        </div>`;
                    }
                }

                html += buttonsHtml;
                html += indentedListHtml;
                // --- END NEW FC PART ---

                html += '</li>';
            });
            html += '</ul></div>'; // Close bank
        });

        // --- NEW: Show "Missing Items" Bank ---
        if (data.missing_items && data.missing_items.length > 0) {
            html += '<div class="fit-slot-bank">';
            html += '<div class="fit-slot-bank-header" style="color: #ff8a8a;">Missing Items</div>'; // Red header
            html += '<ul class="fit-slot-list">';
            data.missing_items.forEach(item => {
                html += `<li class="fit-slot-item" title="${item.name}" style="color: #ff8a8a;">`; // Red text
                html += `<img src="${item.icon_url}" alt="${item.name}" class="fit-modal-icon">`;
                html += `<span class="fit-item-name">${item.name} (x${item.quantity})</span>`;
                html += '</li>';
            });
            html += '</ul></div>';
        }
        // --- END MISSING ITEMS ---

        html += '</div>'; // Close slot-banks
        html += '</div>'; // Close fit-modal-layout
        return html;
    }
    // ---
    // --- END NEW HTML Builder
    // ---


    function openFitModal(fitId) {
        if (!fitModalOverlay) return;

        // --- NEW: Store fitId and show footer buttons ---
        currentModalFitId = fitId;
        if(fitModalAcceptBtn) fitModalAcceptBtn.style.display = 'inline-block';
        if(fitModalDenyBtn) fitModalDenyBtn.style.display = 'inline-block';
        if(fitModalAcceptBtn) fitModalAcceptBtn.disabled = false;
        if(fitModalDenyBtn) fitModalDenyBtn.disabled = false;
        // --- END NEW ---

        // Show modal with spinner
        fitModalBody.innerHTML = '<div class="modal-spinner"></div>';
        fitModalTitle.textContent = "Loading Fit...";
        fitModalOverlay.classList.add('show');

        // Fetch fit details
        fetch(`{% url 'waitlist:api_get_fit_details' %}?fit_id=${fitId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load fit details.');
                }
                return response.json();
            })
            .then(data => {
                // --- MODIFICATION: Handle new JSON structure ---
                // data = { status: "success", name: "...", slotted_fit: {...}, missing_items: [] }

                if (data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load fit.');
                }

                fitModalTitle.textContent = data.name;

                // --- MODIFIED: Use new complex HTML builder ---
                fitModalBody.innerHTML = buildSlottedFitHtml(data);
                // --- END MODIFICATION ---

                // --- MODIFIED: Add event listeners for the new buttons ---
                fitModalBody.querySelectorAll('.js-sub-accept').forEach(button => {
                    button.addEventListener('click', (event) => handleSubstitutionAction(event, 'accept'));
                });
                // --- END MODIFICATION ---

            })
            .catch(error => {
                fitModalBody.innerHTML = `<p style="color: #ff8a8a; padding: 20px;">Error: ${error.message}</p>`;
            });
    }

    function closeFitModal() {
        if (fitModalOverlay) {
            fitModalOverlay.classList.remove('show');

            // --- NEW: Reset modal state ---
            currentModalFitId = null;
            if(fitModalAcceptBtn) fitModalAcceptBtn.style.display = 'none';
            if(fitModalDenyBtn) fitModalDenyBtn.style.display = 'none';
            if(fitModalAcceptBtn) fitModalAcceptBtn.disabled = false;
            if(fitModalDenyBtn) fitModalDenyBtn.disabled = false;
            // --- END NEW ---
        }
    }

    // ---
    // --- CUSTOM CONFIRM MODAL (REMOVED)
    // --- The function 'showCustomConfirm' is now in base.html
    // ---


    // --- MODIFIED: Replaced showSubstitutionDropdown with handleSubstitutionAction ---
    function handleSubstitutionAction(event, action) {
        const button = event.target.closest('button');
        if (!button) return;

        // --- MODIFIED: Remove 'deny' logic ---
        if (action === 'accept') {
            const problemItemId = button.dataset.problemItemId;
            const missingItemId = button.dataset.missingItemId;
            const problemItemName = button.dataset.problemItemName;
            const missingItemName = button.dataset.missingItemName;

            const listItem = button.closest('li.fit-slot-item'); // --- MODIFIED: Use new selector ---

            if (!missingItemId) {
                alert("Missing doctrine item ID not found for substitution.");
                return;
            }

            // Disable the button
            button.disabled = true;

            // --- MODIFIED: Use new custom confirm ---
            const confirmMessage = `Add "<b>${problemItemName}</b>" as a substitute for "<b>${missingItemName}</b>"?`;

            const performSubstitution = () => {
                // This is the code that runs on "Confirm"
                const formData = new FormData();
                formData.append('base_item_id', missingItemId);
                formData.append('substitute_item_id', problemItemId);

                fetch("{% url 'waitlist:api_add_substitution' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // --- MODIFIED: Change color, don't remove ---
                        listItem.classList.remove('fit-item-problem');
                        listItem.classList.add('fit-item-accepted-sub');

                        // Remove the button container
                        const buttonContainer = button.closest('.sub-action-buttons');
                        if (buttonContainer) {
                            buttonContainer.remove();
                        }

                        // Find and update the indented list
                        const missingList = listItem.querySelector('.fit-item-missing-list');
                        if (missingList) {
                            missingList.classList.remove('fit-item-missing-list');
                            missingList.classList.add('fit-item-sub-for-list'); // Change border color

                            // Re-build content as "Substitutes for..."
                            let subHtml = `<li class="fit-item-sub-for-item">`;
                            const missingImg = missingList.querySelector('img');
                            if (missingImg) {
                                subHtml += missingImg.outerHTML;
                            }
                            subHtml += `<span>Substitutes for: ${missingItemName}</span>`;
                            subHtml += `</li>`;
                            missingList.innerHTML = subHtml;
                        }

                        // Don't show an alert, the visual change is the feedback
                        // alert(data.message);
                    } else {
                        alert(`Error: ${data.message}`);
                        button.disabled = false;
                    }
                })
                .catch(error => {
                    alert(`Network Error: ${error.message}`);
                    button.disabled = false;
                });
            };

            // Show the custom confirm box
            showCustomConfirm(confirmMessage, performSubstitution);

            // Re-enable button if user cancels (the 'cancel' button on the
            // confirm modal will just hide the modal, so we must re-enable)
            // We'll add a one-time listener to the cancel button for this.
            const confirmCancelBtn = document.getElementById('custom-confirm-cancel-btn');
            const confirmOkBtn = document.getElementById('custom-confirm-ok-btn');

            const tempCancelListener = () => {
                button.disabled = false;
                confirmCancelBtn.removeEventListener('click', tempCancelListener);
                confirmOkBtn.removeEventListener('click', tempCancelListener); // Also clear if they click OK
            };
            confirmCancelBtn.addEventListener('click', tempCancelListener);
            confirmOkBtn.addEventListener('click', tempCancelListener); // Clean up listener
            // --- END MODIFICATION ---

        }
        // --- No 'deny' logic ---
    }
    // --- END MODIFICATION ---


    // Add close listeners for the modal
    if (fitModalOverlay) {
        fitModalCloseBtn.addEventListener('click', closeFitModal);
        fitModalCancelBtn.addEventListener('click', closeFitModal);
        fitModalOverlay.addEventListener('click', (e) => {
            if (e.target === fitModalOverlay) {
                closeFitModal();
            }
        });
    }


    // This function sets up all our event listeners
    function initializeWaitlist() {

        // --- NEW: Add listeners for modal footer buttons ---
        if (isFC) {
            if(fitModalAcceptBtn) fitModalAcceptBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    // Reuse the existing FC action handler
                    // We mock the 'event' object it expects
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'approve'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal(); // Close modal after action
                }
            });

            if(fitModalDenyBtn) fitModalDenyBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'deny'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal(); // Close modal after action
                }
            });
        }
        // --- END NEW ---

        // --- 4. MODIFIED: Add event delegation ---
        waitlistContainer.addEventListener('click', (event) => {
            // Check for FC action click
            const fcButton = event.target.closest('.fc-btn');
            if (isFC && fcButton) {
                // --- MODIFICATION: Route to correct handler ---
                if (fcButton.classList.contains('btn-invite')) {
                    handleFCInvite(event);
                } else {
                    handleFCAction(event);
                }
                // --- END MODIFICATION ---
                return; // Stop processing
            }

            // Check for Fit Modal click
            const fitModalButton = event.target.closest('.js-open-fit-modal');
            if (isFC && fitModalButton) {
                const fitId = fitModalButton.dataset.fitId;
                openFitModal(fitId);
                return; // Stop processing
            }
        });
        // --- END MODIFICATION ---

        // Run timers
        updateWaitTimers(); // Run once on load
        if (timerInterval) clearInterval(timerInterval); // Clear old timer
        timerInterval = setInterval(updateWaitTimers, 10000); // Update timers every 10s

        // ---
        // --- REMOVED: Polling interval is no longer needed
        // ---
        // if (pollingInterval) clearInterval(pollingInterval); // Clear old poller
        // pollingInterval = setInterval(fetchWaitlistHTML, 5000); // Poll every 5s
    }

    // ---
    // --- NEW: FLEET OVERVIEW JAVASCRIPT (Moved from fc_admin.html)
    // ---
    let fleetOverviewInterval = null;
    const overviewSection = document.getElementById('fleet-overview-column');
    const overviewCountsContainer = document.getElementById('fleet-ship-counts-container');
    const overviewBody = document.getElementById('fleet-structure-overview-body');

    function loadFleetOverview(showOverlay = false) {
        // Stop if the element doesn't exist (e.g., user is not FC or waitlist closed)
        if (!overviewSection) {
            stopFleetOverviewPolling(); // Ensure polling is stopped
            return;
        }

        // We don't use the full-screen overlay here, just show "loading" text
        if (showOverlay) {
            overviewCountsContainer.innerHTML = `<p style="color: #888; font-size: 0.85em; margin: 0;">Refreshing...</p>`;
            overviewBody.innerHTML = `<p style="color: #888; font-size: 0.85em; margin: 0;">Refreshing...</p>`;
        }

        fetch("{% url 'waitlist:api_get_fleet_members' %}")
            .then(response => {
                if (response.status === 404) {
                    // ESI fleet not found, stop polling
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">ESI fleet not found. Polling stopped.</p>`;
                    overviewCountsContainer.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Fleet Not Found</p>`;
                    stopFleetOverviewPolling();
                    throw new Error('Fleet not found');
                }
                if (!response.ok) {
                    throw new Error('Network error');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // ---
                    // --- NEW: Render Detailed Ship Counts (Grid Layout)
                    // ---
                    const counts = data.detailed_ship_counts;
                    let countsHtml = '';

                    // Helper to build a category
                    const buildCategoryHtml = (categoryName, ships) => {
                        // Create a block for this category
                        let html = `<div class="ship-count-category-block">`;
                        html += `<div class="ship-count-category">${categoryName}</div>`;
                        html += `<ul class="ship-count-list">`;
                        ships.forEach(ship => {
                            html += `<li class="ship-count-item" title="${ship.name}">
                                        <img src="https://images.evetech.net/types/${ship.type_id}/icon?size=32" alt="${ship.name}">
                                        <span>${ship.name}</span>
                                        <strong>${ship.count}</strong>
                                     </li>`;
                        });
                        html += `</ul></div>`;
                        return html;
                    };

                    // --- NEW: Build HTML for each grid cell ---
                    const maraudersHtml = buildCategoryHtml('Marauders', counts.marauders);
                    const logiHtml = buildCategoryHtml('Logistics', counts.logi);
                    const boostersHtml = buildCategoryHtml('Boosters', counts.boosters);
                    const vindiHtml = buildCategoryHtml('Vindicators', counts.vindicators);

                    // --- NEW: Combine into grid structure ---
                    overviewCountsContainer.innerHTML = `
                        ${maraudersHtml}
                        ${logiHtml}
                        ${boostersHtml}
                        ${vindiHtml}
                    `;
                    // ---
                    // --- END NEW Ship Counts
                    // ---

                    // 2. Render Fleet Structure
                    let structureHtml = '';

                    // 1. Render Fleet Command (Boss)
                    structureHtml += `<div class="overview-fleet-command">`;
                    structureHtml += `<div class="overview-fc-header">
                                        <span>${data.fleet_boss_name} (${data.total_member_count})</span>
                                        <span class="overview-fc-star">★</span>
                                    </div>`;

                    // 2. Render Fleet Commander (Role) if one exists
                    if (data.fleet_commander) {
                        const fc = data.fleet_commander;
                        structureHtml += `<div class="overview-fc-member" title="${fc.character_name} (${fc.ship_name})">${fc.character_name} <span class="overview-member-ship">(${fc.ship_name})</span></div>`;
                    }
                    structureHtml += `</div>`; // Close fleet-command


                    // 3. Render Wings
                    if (data.wings.length > 0) {
                        data.wings.forEach(wing => {
                            structureHtml += `<div class="overview-wing">`;
                            structureHtml += `<div class="overview-wing-header" title="${wing.name}">${wing.name} (${wing.member_count})</div>`;

                            // Render Wing Commander
                            if (wing.wing_commander) {
                                const wc = wing.wing_commander;
                                structureHtml += `<div class="overview-wc" title="${wc.character_name} (${wc.ship_name})">${wc.character_name} <span class="overview-member-ship">(${wc.ship_name})</span></div>`;
                            }

                            // Render Squads
                            wing.squads.forEach(squad => {
                                structureHtml += `<div class="overview-squad">`;
                                structureHtml += `<div class="overview-squad-header" title="${squad.name}">${squad.name} (${squad.member_count})</div>`;

                                // Render Squad Commander
                                if (squad.squad_commander) {
                                    const sc = squad.squad_commander;
                                    structureHtml += `<div class="overview-sc" title="${sc.character_name} (${sc.ship_name})">${sc.character_name} <span class="overview-member-ship">(${sc.ship_name})</span></div>`;
                                }

                                // Render Squad Members
                                if (squad.members.length > 0) {
                                    structureHtml += `<ul class="overview-member-list">`;
                                    squad.members.forEach(member => {
                                        structureHtml += `<li class="overview-member" title="${member.character_name} (${member.ship_name})">${member.character_name} <span class="overview-member-ship">(${member.ship_name})</span></li>`;
                                    });
                                    structureHtml += `</ul>`;
                                }
                                structureHtml += `</div>`;
                            });
                            structureHtml += `</div>`;
                        });
                    } else if (!data.fleet_commander) {
                        // Only show "fleet empty" if no wings AND no FC role
                        structureHtml += '<p style="color: #888; font-size: 0.85em; margin: 0;">Fleet is empty.</p>';
                    }

                    overviewBody.innerHTML = structureHtml;

                } else {
                    // Show error from our API
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Error: ${data.message}</p>`;
                    overviewCountsContainer.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Error</p>`;
                }
            })
            .catch(err => {
                if (err.message !== 'Fleet not found') {
                    overviewBody.innerHTML = `<p style="color: #ff8a8a; font-size: 0.85em; margin: 0;">Network Error: ${err.message}</p>`;
                }
            });
    }

    function startFleetOverviewPolling() {
        stopFleetOverviewPolling(); // Clear any old one
        console.log("Starting fleet overview polling (5s)...");
        // Run immediately, then set interval
        loadFleetOverview(true);
        fleetOverviewInterval = setInterval(() => loadFleetOverview(false), 5000);
    }

    function stopFleetOverviewPolling() {
        if (fleetOverviewInterval) {
            console.log("Stopping fleet overview polling.");
            clearInterval(fleetOverviewInterval);
            fleetOverviewInterval = null;
        }
    }
    // ---
    // --- END NEW FLEET OVERVIEW JAVASCRIPT
    // ---


    // Add close listeners for the modal
    if (fitModalOverlay) {
        fitModalCloseBtn.addEventListener('click', closeFitModal);
        fitModalCancelBtn.addEventListener('click', closeFitModal);
        fitModalOverlay.addEventListener('click', (e) => {
            if (e.target === fitModalOverlay) {
                closeFitModal();
            }
        });
    }


    // This function sets up all our event listeners
    function initializeWaitlist() {

        // --- NEW: Add listeners for modal footer buttons ---
        if (isFC) {
            if(fitModalAcceptBtn) fitModalAcceptBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    // Reuse the existing FC action handler
                    // We mock the 'event' object it expects
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'approve'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal(); // Close modal after action
                }
            });

            if(fitModalDenyBtn) fitModalDenyBtn.addEventListener('click', () => {
                if (currentModalFitId) {
                    const mockEvent = {
                        target: {
                            closest: () => ({
                                dataset: {
                                    fitId: currentModalFitId,
                                    action: 'deny'
                                }
                            })
                        }
                    };
                    handleFCAction(mockEvent);
                    closeFitModal(); // Close modal after action
                }
            });
        }
        // --- END NEW ---

        // --- 4. MODIFIED: Add event delegation ---
        waitlistContainer.addEventListener('click', (event) => {
            // Check for FC action click
            const fcButton = event.target.closest('.fc-btn');
            if (isFC && fcButton) {
                // --- MODIFICATION: Route to correct handler ---
                if (fcButton.classList.contains('btn-invite')) {
                    handleFCInvite(event);
                } else {
                    handleFCAction(event);
                }
                // --- END MODIFICATION ---
                return; // Stop processing
            }

            // Check for Fit Modal click
            const fitModalButton = event.target.closest('.js-open-fit-modal');
            if (isFC && fitModalButton) {
                const fitId = fitModalButton.dataset.fitId;
                openFitModal(fitId);
                return; // Stop processing
            }
        });
        // --- END MODIFICATION ---

        // Run timers
        updateWaitTimers(); // Run once on load
        if (timerInterval) clearInterval(timerInterval); // Clear old timer
        timerInterval = setInterval(updateWaitTimers, 10000); // Update timers every 10s

        // ---
        // --- REMOVED: Polling interval is no longer needed
        // ---
        // if (pollingInterval) clearInterval(pollingInterval); // Clear old poller
        // pollingInterval = setInterval(fetchWaitlistHTML, 5000); // Poll every 5s
    }

    // --- 5. PAGE INITIALIZATION ---

    document.addEventListener('DOMContentLoaded', () => {
        // Enable the X-Up button (it's disabled by default in base.html)
        // We do this here so it's only enabled if the page loads correctly.
        const xupButton = document.getElementById('xup-modal-button');
        const openWaitlist = {{ open_waitlist.pk|default:"null" }};

        if (xupButton && openWaitlist !== null) {
            xupButton.disabled = false;
        }

        // Start all the interactive parts
        initializeWaitlist();

        // --- NEW: Start overview polling if FC ---
        if (isFC && openWaitlist !== null) {
            startFleetOverviewPolling();
        }
        // --- END NEW ---


        // ---
        // --- NEW: EventSource / Server-Sent Events (SSE) ---
        // ---
        // We replace the old pollingInterval with this.
        console.log("Connecting to event stream /events/waitlist-updates/...");

        // Connect to the event stream URL
        // ---
        // --- THIS IS THE FIX ---
        // --- We pass the channel name as a query parameter, not a path ---
        const eventSource = new EventSource("/events/?channel=waitlist-updates");
        // ---
        // --- END THE FIX ---
        // ---

        // --- THIS IS THE FIX: Listen for the 'update' event type ---
        // The server sends events with type 'update', not the default 'message'.
        eventSource.addEventListener('update', (event) => {
            console.log("Received 'update' event from server:", event.data);
            // We received an update!
            // Call our existing function to refresh the HTML.
            fetchWaitlistHTML();

            // --- NEW: Also check if waitlist was closed ---
            try {
                const data = JSON.parse(event.data);
                if (data.action === 'close') {
                    console.log("Waitlist closed event received, stopping overview polling.");
                    stopFleetOverviewPolling();
                    // Reload the page to show the "waitlist closed" message
                    window.location.reload();
                }
            } catch (e) {
                // Ignore parse error, just fetch HTML
            }
            // --- END NEW ---
        });
        // --- END THE FIX ---

        // Optional: Handle connection open
        eventSource.onopen = (event) => {
            console.log("EventSource connection opened.");
        };

        // Optional: Handle errors
        eventSource.onerror = (event) => {
            console.error("EventSource error:", event);
            // Don't close, EventSource will try to reconnect automatically
        };
        // ---
        // --- END NEW: EventSource ---
        // ---
    });

</script>
{% endblock %}