{% extends "base.html" %}
{% load humanize %}

<!-- Set the page title -->
{% block title %}FC Admin - Waitlist Management{% endblock %}

{% block styles %}
<style>
    /* ---
    --- NEW COMPACT STYLES
    --- */
    .container {
        /* Widen container to fit side-by-side elements */
        max-width: 1200px;
        margin: 20px auto;
        background: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* --- NEW: ESI Loading Overlay Styles (from pilot_detail.html) --- */
    #esi-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none; /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000; /* On top of everything */
    }

        #esi-loading-overlay.show {
            display: flex;
        }

    .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #555;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    #esi-loading-overlay p {
        color: #fff;
        font-size: 1.2em;
        margin-top: 20px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    /* --- END NEW Overlay --- */


    h1 {
        border-bottom: 0px solid #444;
        padding-bottom: 10px;
        margin-top: 0;
    }

    .admin-section {
        background: #333;
        border: 0px solid #444;
        border-radius: 8px;
        padding: 15px; /* Reduced padding */
        margin-top: 15px; /* Reduced margin */
    }

        .admin-section h2 {
            margin-top: 0;
            font-size: 1.3em; /* Smaller header */
        }

    /* --- MODIFIED: Renamed to top-management-grid --- */
    .top-management-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    /* --- NEW: Grid for status and close button --- */
    .status-grid {
        display: grid;
        grid-template-columns: 3fr 1fr; /* 3 parts for info, 1 for button */
        gap: 15px;
        align-items: end; /* Align items to bottom */
    }

    .status-info {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns for info fields */
        gap: 10px;
    }

    #close-waitlist-form {
        margin: 0;
    }

        #close-waitlist-form .btn {
            width: 100%; /* Make button fill its grid cell */
        }
    /* --- END NEW GRIDS --- */


    .status-open {
        color: #28a745;
    }

    .status-closed {
        color: #dc3545;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px; /* Reduced gap */
        margin-bottom: 10px; /* Reduced margin */
    }

        .form-group label {
            font-weight: 600;
            color: #ccc;
            font-size: 0.9em; /* Smaller label */
        }

        .form-group input,
        .form-group select {
            background: #222;
            border: 0px solid #555;
            border-radius: 5px;
            padding: 8px 10px; /* Reduced padding */
            color: #fff;
            font-family: inherit;
            font-size: 0.95em; /* Smaller font */
        }

            .form-group input[readonly] {
                background: #1a1a1a;
                color: #888;
                cursor: not-allowed;
            }

        .form-group p { /* Compact help text */
            color: #aaa;
            font-style: italic;
            font-size: 0.85em;
            margin: 2px 0 0 0;
        }

    .btn {
        display: inline-block;
        padding: 8px 14px; /* Reduced padding */
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.95em; /* Smaller font */
        transition: background-color 0.3s;
        cursor: pointer;
        border: none;
    }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

    .btn-danger {
        background-color: #993333;
    }

        .btn-danger:hover {
            background-color: #b33a3a;
        }

    .btn-success {
        background-color: #218838;
    }

        .btn-success:hover {
            background-color: #28a745;
        }

    .btn-warning {
        background-color: #a67c00;
    }

        .btn-warning:hover {
            background-color: #c99900;
        }

    .btn-primary {
        background-color: #3b5998;
    }

        .btn-primary:hover {
            background-color: #4e71bb;
        }

    /* Message styles */
    .message {
        padding: 10px 15px; /* Reduced padding */
        margin-bottom: 15px; /* Reduced margin */
        border-radius: 5px;
        font-weight: 500;
        font-size: 0.95em;
    }

    .message-success {
        background: #28a745;
        color: #fff;
    }

    .message-error {
        background: #dc3545;
        color: #fff;
    }

    .message-loading {
        background: #007bff;
        color: #fff;
    }

    /* ---
    --- FLEET STRUCTURE (COMPACT)
    --- */
    .fleet-structure-container {
        border-top: 0px solid #444;
        margin-top: 15px; /* Reduced margin */
        padding-top: 15px; /* Reduced padding */
    }

    .fleet-structure-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px; /* Reduced margin */
        /* --- NEW: Wrap buttons --- */
        flex-wrap: wrap;
        gap: 10px;
    }

        .fleet-structure-header .btn {
            padding: 6px 10px; /* Smaller button */
            font-size: 0.9em;
        }

    /* --- NEW: Container for layout buttons --- */
    .layout-buttons {
        display: flex;
        gap: 10px;
    }

    .fleet-wing {
        background: #2a2a2a;
        border: 0px solid #444;
        border-radius: 5px;
        margin-bottom: 10px; /* Reduced margin */
    }

    /* --- NEW STYLES FOR WING/SQUAD BUTTONS --- */
    .wing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        background: #3a3a3a;
        padding: 8px 12px; /* Reduced padding */
        font-size: 1em; /* Smaller font */
        font-weight: 600;
        border-bottom: 0px solid #444;
        border-radius: 5px 5px 0 0;
    }

    .wing-header-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-wing-action {
        background: #555;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.8em;
        padding: 4px 8px;
        transition: background-color 0.2s;
    }

        .btn-wing-action:hover {
            background: #666;
        }

    /* --- THIS IS THE FIX: This class is now used --- */
    .btn-delete-wing {
        background: #993333;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.1em;
        line-height: 1;
        padding: 3px 6px;
        flex-shrink: 0; /* Don't shrink */
        transition: background-color 0.2s;
    }

        .btn-delete-wing:hover {
            background: #b33a3a;
        }


    .wing-name-input {
        /* This is the new text input for the wing name */
        flex-grow: 1; /* Take up available space */
        background: #222;
        border: 0px solid #555;
        border-radius: 5px;
        padding: 5px 8px;
        color: #fff;
        font-family: inherit;
        font-size: 1em;
        font-weight: 600;
        min-width: 150px;
    }
    /* --- END WING/SQUAD BUTTONS --- */


    .squad-list {
        padding: 10px 12px; /* Reduced padding */
        display: grid;
        grid-template-columns: 1fr; /* --- MODIFIED: Single column grid --- */
        gap: 8px 15px; /* Reduced gap */
    }

    .squad-item {
        display: flex;
        align-items: center;
        gap: 8px; /* Reduced gap */
    }

    /* --- NEW: Squad name text input --- */
    .squad-name-input {
        flex-basis: 150px; /* Start at 150px */
        flex-grow: 1; /* Grow to fill */
        flex-shrink: 1; /* Allow shrinking */
        background: #222;
        border: 0px solid #555;
        border-radius: 5px;
        padding: 5px 8px; /* Smaller select box */
        color: #fff;
        font-family: inherit;
        font-size: 0.9em;
        min-width: 100px;
    }

    .squad-item select {
        width: auto; /* Let it size to content */
        flex-basis: 150px; /* Start at 150px */
        flex-grow: 1;
        flex-shrink: 1;
        padding: 5px 8px; /* Smaller select box */
        font-size: 0.9em;
        min-width: 100px;
    }

    /* --- NEW: Squad delete button --- */
    .btn-delete-squad {
        background: #993333;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.1em;
        line-height: 1;
        padding: 3px 6px;
        flex-shrink: 0; /* Don't shrink */
        transition: background-color 0.2s;
    }

        .btn-delete-squad:hover {
            background: #b33a3a;
        }


    #btn-save-mappings {
        margin-top: 10px;
        margin-right: 10px;
    }

    /* ---
    --- REMOVED FLEET OVERVIEW STYLES
    --- */

    /* Responsive layout for structure */
    @media (max-width: 900px) {
        /* Stack the main grid on smaller screens */
        /* --- MODIFIED: Renamed selector --- */
        .top-management-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 600px) {
        /* --- MODIFIED: Go to 2 columns on wider screens --- */
        .squad-list {
            grid-template-columns: 1fr 1fr;
        }
    }


    @media (max-width: 600px) {
        /* Stack the status grid */
        .status-grid {
            grid-template-columns: 1fr;
        }

        .status-info {
            grid-template-columns: 1fr;
        }

        .squad-item {
            /* --- MODIFIED: Allow wrapping --- */
            flex-wrap: wrap;
        }

            .squad-name-input,
            .squad-item select {
                /* --- MODIFIED: Full width on small screens --- */
                flex-basis: 100%;
                width: 100%;
            }

        /* --- REMOVED: Fleet overview responsive styles --- */
    }

    /* ---
    --- END COMPACT STYLES
    --- */

</style>
{% endblock %}


{% block content %}
<!-- --- NEW: ESI Loading Overlay --- -->
<div id="esi-loading-overlay">
    <div class="spinner"></div>
    <p id="esi-loading-text">Communicating with ESI...</p>
</div>
<!-- --- END NEW --- -->

<div class="container">
    <h1>FC Waitlist Management</h1>

    <!-- This div will hold our status messages -->
    <div id="message-container"></div>

    <!-- --- NEW: Link to Rule Helper --- -->
    <div class="admin-section">
        <a href="{% url 'waitlist:fc_rule_helper' %}" class="btn btn-primary" style="background-color: #5a3b98;">
            Doctrine Rule Helper
        </a>
        <div class="form-group" style="margin-top: 10px;">
            <p>
                Use the Rule Helper to quickly set up the "equal or better"
                logic for all modules in your doctrines.
            </p>
        </div>
    </div>
    <!-- --- END NEW --- -->
    {% if open_waitlist %}
    <!--
    =================================
    SECTION 1: A Waitlist is OPEN
    =================================
    -->
    <!-- --- NEW: Top Grid for Status and Linking --- -->
    <div class="top-management-grid">

        <!-- Status Grid -->
        <div class="admin-section" id="section-waitlist-status">
            <div class="status-grid">
                <div class="status-info">
                    <div class="form-group">
                        <label>Current Description</label>
                        <input type="text" value="{{ open_waitlist.fleet.description }}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Current FC</label>
                        <input type="text" value="{{ open_waitlist.fleet.fleet_commander.character_name|default:'Not Assigned' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Current ESI Fleet ID</label>
                        <input type="text" id="esi-fleet-id-display" value="{{ open_waitlist.fleet.esi_fleet_id|default:'Not Linked' }}" readonly>
                    </div>
                </div>

                <form id="close-waitlist-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="close">
                    <button type="submit" class="btn btn-danger" id="close-waitlist-btn">Close This Waitlist</button>
                </form>
            </div>
        </div>
        <!-- END Status Grid -->
        <!-- "TAKE OVER" / "LINK FLEET" FORM -->
        <div class="admin-section" id="section-link-fleet">
            <h2>Link In-Game Fleet</h2>
            <form id="link-fleet-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="takeover">

                <div class="form-group">
                    <label for="link-fc-select">Your FC Character</label>
                    <select id="link-fc-select" name="fleet_commander_id" required>
                        <option value="">-- Select your character --</option>
                        {% for char in user_fc_characters %}
                        <option value="{{ char.character_id }}"
                                {% if open_waitlist.fleet.fleet_commander and open_waitlist.fleet.fleet_commander.character_id == char.character_id %} selected{% endif %}>
                            {{ char.character_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <p>
                        You must be in a fleet and be the fleet boss. This will link your current fleet to the waitlist.
                    </p>
                </div>

                <button type="submit" class="btn btn-warning" id="link-fleet-btn">Link Fleet</button>
            </form>
        </div>
        <!-- END Link Fleet Form -->

    </div>
    <!-- --- END NEW: Top Grid --- -->
    <!--
    ---
    --- REMOVED: FLEET OVERVIEW SECTION
    ---
    -->
    <!-- --- MODIFIED: Fleet structure is now full-width below --- -->
    <div class="admin-section" id="section-fleet-structure" {% if not open_waitlist.fleet.esi_fleet_id %}style="display: none;" {% endif %}>
        <div class="fleet-structure-header">
            <h2>Fleet Structure & Mappings</h2>
            <!-- --- NEW: Button container --- -->
            <div class="layout-buttons">
                <button type="button" class="btn btn-primary" id="btn-create-layout">Create Default Layout</button>
                <!-- --- NEW: Add Wing Button --- -->
                <button type="button" class="btn btn-primary" id="btn-add-wing">Add New Wing</button>
            </div>
        </div>

        <div class="form-group">
            <p>
                Assign categories to your in-game squads. Pilots invited from a category
                will be sent directly to that squad.
            </p>
        </div>

        <!-- This container will be filled by JavaScript -->
        <div id="fleet-structure-body">
            <p>Loading fleet structure...</p>
        </div>

        <button type="button" class="btn btn-success" id="btn-save-mappings">Save Mappings</button>
        <button type="button" class="btn btn-primary" id="btn-refresh-structure">Refresh Structure</button>

    </div>
    <!-- --- END MODIFICATION --- -->
    {% else %}
    <!--
    =================================
    SECTION 2: The Waitlist is CLOSED
    =================================
    -->
    <div class="admin-section" id="section-waitlist-closed">
        <h2>Current Waitlist Status: <span class="status-closed">CLOSED</span></h2>

        <form id="open-waitlist-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="open">

            <div class="form-group">
                <p>Use the form below to open a new waitlist. You can link an in-game fleet later.</p>
            </div>

            <div class="form-group">
                <label for="fc-select">Your FC Character</label>
                <select id="fc-select" name="fleet_commander_id" required>
                    <option value="">-- Select your character --</option>
                    {% for char in user_fc_characters %}
                    <option value="{{ char.character_id }}">{{ char.character_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="fleet-select">Fleet Type</label>
                <select id="fleet-select" name="fleet_id" required>
                    <option value="">-- Select fleet type --</option>
                    {% for fleet in available_fleets %}
                    <option value="{{ fleet.id }}">{{ fleet.description }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn btn-success" id="open-waitlist-btn">Open New Waitlist</button>
        </form>
    </div>
    {% endif %}

</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const messageContainer = document.getElementById('message-container');
        const apiUrl = "{% url 'waitlist:api_fc_manage_waitlist' %}";

        // --- NEW: ESI Overlay Elements ---
        const esiOverlay = document.getElementById('esi-loading-overlay');
        const esiOverlayText = document.getElementById('esi-loading-text');

        // --- NEW: ESI Overlay Helper Functions ---
        function showEsiOverlay(message) {
            if (!esiOverlay || !esiOverlayText) return;
            esiOverlayText.textContent = message;
            esiOverlay.classList.add('show');
        }

        function hideEsiOverlay() {
            if (!esiOverlay) return;
            esiOverlay.classList.remove('show');
        }


        // --- Helper to show messages ---
        function showMessage(type, text) {
            messageContainer.innerHTML = `<div class="message message-${type}">${text}</div>`;
        }

        // --- Helper to clear messages ---
        function clearMessage() {
            messageContainer.innerHTML = "";
        }

        // --- Get CSRF token ---
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // --- 1. Handle OPEN Waitlist ---
        const openForm = document.getElementById('open-waitlist-form');
        if (openForm) {
            openForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const button = document.getElementById('open-waitlist-btn');
                button.disabled = true;
                // --- MODIFIED: No ESI call here, so no overlay ---
                showMessage('loading', 'Opening waitlist...');

                const formData = new FormData(openForm);

                fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showMessage('success', data.message);
                            window.location.reload(); // Reload to show the new state
                        } else {
                            showMessage('error', `Error: ${data.message}`);
                            button.disabled = false;
                        }
                    })
                    .catch(err => {
                        showMessage('error', `Network Error: ${err}`);
                        button.disabled = false;
                    });
            });
        }

        // --- 2. Handle CLOSE Waitlist ---
        const closeForm = document.getElementById('close-waitlist-form');
        if (closeForm) {
            closeForm.addEventListener('submit', (e) => {
                e.preventDefault();

                showCustomConfirm(
                    'Are you sure you want to close this waitlist? All pending fits will be denied.',
                    () => {
                        const button = document.getElementById('close-waitlist-btn');
                        button.disabled = true;
                        // --- MODIFIED: No ESI call, so no overlay ---
                        showMessage('loading', 'Closing waitlist...');

                        const formData = new FormData(closeForm);

                        fetch(apiUrl, {
                            method: 'POST',
                            body: formData,
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    showMessage('success', data.message);
                                    // --- NEW: Stop polling on close ---
                                    // (Polling logic is no longer in this file)
                                    // --- END NEW ---
                                    window.location.reload(); // Reload to show the new state
                                } else {
                                    showMessage('error', `Error: ${data.message}`);
                                    button.disabled = false;
                                }
                            })
                            .catch(err => {
                                showMessage('error', `Network Error: ${err}`);
                                button.disabled = false;
                            });
                    }
                );
            });
        }

        // --- 3. Handle "Link Fleet" (formerly TAKEOVER) ---
        const linkFleetForm = document.getElementById('link-fleet-form');
        if (linkFleetForm) {
            linkFleetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const button = document.getElementById('link-fleet-btn');
                button.disabled = true;
                // --- MODIFIED: Use ESI Overlay ---
                clearMessage();
                showEsiOverlay('Linking to ESI Fleet...');

                const formData = new FormData(linkFleetForm);

                fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showMessage('success', data.message);
                            document.getElementById('esi-fleet-id-display').value = data.esi_fleet_id;
                            // --- NEW: Show overview section ---
                            // document.getElementById('section-fleet-overview').style.display = 'block';
                            // --- END NEW ---
                            document.getElementById('section-fleet-structure').style.display = 'block';
                            loadFleetStructure();
                            // --- NEW: Load overview and start polling ---
                            // --- REMOVED: Polling logic moved to waitlist_view.html ---
                            // --- END NEW ---
                            button.disabled = false;
                        } else {
                            showMessage('error', `Error: ${data.message}`);
                            button.disabled = false;
                        }
                    })
                    .catch(err => {
                        showMessage('error', `Network Error: ${err}`);
                        button.disabled = false;
                    })
                    // --- NEW: Hide overlay on finish ---
                    .finally(() => {
                        hideEsiOverlay();
                    });
            });
        }


        // ---
        // --- 4. NEW: Fleet Structure Logic
        // ---
        const structureSection = document.getElementById('section-fleet-structure');
        const structureBody = document.getElementById('fleet-structure-body');
        const saveMappingsBtn = document.getElementById('btn-save-mappings');
        const createLayoutBtn = document.getElementById('btn-create-layout');
        const refreshStructureBtn = document.getElementById('btn-refresh-structure');

        // Function to load and render the fleet structure
        function loadFleetStructure() {
            if (!structureBody) return;
            structureBody.innerHTML = '<p>Loading fleet structure...</p>';

            // --- MODIFIED: This function DOES NOT show the ESI overlay, ---
            // --- as it's called by other functions that already show it. ---
            // --- The main "Refresh" button will call refreshStructureFromESI() ---

            fetch("{% url 'waitlist:api_get_fleet_structure' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderFleetStructure(data.structure);
                    } else {
                        structureBody.innerHTML = `<p style="color: #ff8a8a;">Error: ${data.message}</p>`;
                    }
                })
                .catch(err => {
                    structureBody.innerHTML = `<p style="color: #ff8a8a;">Network Error: ${err.message}</p>`;
                });
        }

        // Function to render the HTML for the structure
        function renderFleetStructure(structure) {
            let html = '';

            // Build the <option> tags for categories
            let categoryOptions = '<option value="">-- None --</option>';
            structure.available_categories.forEach(cat => {
                categoryOptions += `<option value="${cat.id}">${cat.name}</option>`;
            });

            // Build the wings and squads
            structure.wings.forEach(wing => {
                html += `<div class="fleet-wing" data-wing-id="${wing.id}">`;
                html += `<div class="wing-header">`;

                html += `<input type="text" class="wing-name-input" value="${wing.name}" data-wing-id="${wing.id}">`;

                html += `<div class="wing-header-controls">`;
                html += `<button class="btn-wing-action btn-add-squad" data-wing-id="${wing.id}" title="Add New Squad">+ Add Squad</button>`;

                // ---
                // --- THIS IS THE FIX ---
                // ---
                // The comment was wrong, but the code was ALSO wrong.
                // The class is now corrected to `btn-delete-wing`.
                html += `<button class="btn-delete-wing" data-wing-id="${wing.id}" data-wing-name="${wing.name}" title="Delete Wing">&times;</button>`;
                // ---
                // --- END THE FIX ---
                // ---

                html += `</div></div>`;

                html += `<div class="squad-list">`;

                wing.squads.forEach(squad => {
                    html += `<div class="squad-item" data-squad-id="${squad.id}">`;
                    html += `<input type="text" class="squad-name-input" value="${squad.name}" title="${squad.name} (ID: ${squad.id})">`;
                    html += `<select data-squad-id="${squad.id}" class="squad-category-select">`;
                    html += categoryOptions; // Add all options
                    html += `</select>`;
                    html += `<button class="btn-delete-squad" data-squad-id="${squad.id}" data-squad-name="${squad.name}" title="Delete Squad">&times;</button>`;
                    html += `</div>`;
                });

                html += `</div></div>`;
            });

            structureBody.innerHTML = html;

            // Now, pre-select the saved options
            structure.wings.forEach(wing => {
                wing.squads.forEach(squad => {
                    if (squad.assigned_category) {
                        const select = document.querySelector(`.squad-item[data-squad-id="${squad.id}"] .squad-category-select`);
                        if (select) {
                            select.value = squad.assigned_category;
                        }
                    }
                });
            });

            addStructureButtonListeners();
        }

        // --- 5. Handle SAVE Mappings ---
        if (saveMappingsBtn) {
            saveMappingsBtn.addEventListener('click', () => {

                const wings = document.querySelectorAll('.fleet-wing');
                let wingData = [];
                let squadData = [];

                wings.forEach(wing => {
                    const wingId = wing.dataset.wingId;
                    const wingNameInput = wing.querySelector('.wing-name-input');
                    if (wingNameInput) {
                        wingData.push({
                            id: wingId,
                            name: wingNameInput.value
                        });
                    }

                    wing.querySelectorAll('.squad-item').forEach(squad => {
                        const squadId = squad.dataset.squadId;
                        const squadNameInput = squad.querySelector('.squad-name-input');
                        const squadCategorySelect = squad.querySelector('.squad-category-select');

                        if (squadNameInput && squadCategorySelect) {
                            squadData.push({
                                id: squadId,
                                name: squadNameInput.value,
                                category: squadCategorySelect.value || null
                            });
                        }
                    });
                });

                saveMappingsBtn.disabled = true;
                // --- MODIFIED: Use ESI Overlay ---
                clearMessage();
                showEsiOverlay('Saving Mappings & Syncing with ESI...');

                fetch("{% url 'waitlist:api_save_squad_mappings' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ wings: wingData, squads: squadData })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // --- MODIFIED: Success message, then render ---
                            showMessage('success', 'Mappings saved and fleet updated.');
                            // The backend now returns the fresh structure
                            renderFleetStructure(data.structure);
                        } else {
                            showMessage('error', `Error: ${data.message}`);
                        }
                    })
                    .catch(err => {
                        showMessage('error', `Network Error: ${err.message}`);
                    })
                    .finally(() => {
                        saveMappingsBtn.disabled = false;
                        // --- NEW: Hide overlay ---
                        hideEsiOverlay();
                    });
            });
        }

        // --- 6. Handle CREATE Default Layout ---
        if (createLayoutBtn) {
            createLayoutBtn.addEventListener('click', () => {

                showCustomConfirm(
                    "This will rename and create wings/squads in your active EVE fleet to match the default layout. Are you sure?",
                    () => {
                        // Run on confirm
                        createLayoutBtn.disabled = true;
                        // --- MODIFIED: Use ESI Overlay ---
                        clearMessage();
                        showEsiOverlay('Pushing Default Layout to ESI...');

                        fetch("{% url 'waitlist:api_fc_create_default_layout' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    showMessage('success', data.message);
                                    refreshStructureFromESI(false); // Refresh without overlay
                                } else {
                                    showMessage('error', `Error: ${data.message}`);
                                }
                            })
                            .catch(err => {
                                showMessage('error', `Network Error: ${err.message}`);
                            })
                            .finally(() => {
                                createLayoutBtn.disabled = false;
                                // --- NEW: Hide overlay ---
                                hideEsiOverlay();
                            });
                    }
                );
            });
        }

        // --- 7. Handle REFRESH Structure ---
        // --- MODIFIED: Added 'showOverlay' flag ---
        function refreshStructureFromESI(showOverlay = true) {
            clearMessage();
            if (showOverlay) {
                showEsiOverlay('Refreshing Fleet Structure from ESI...');
            }
            if (refreshStructureBtn) refreshStructureBtn.disabled = true;

            fetch("{% url 'waitlist:api_fc_refresh_structure' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (showOverlay) {
                            showMessage('success', 'Fleet structure refreshed.');
                        }
                        renderFleetStructure(data.structure);
                    } else {
                        showMessage('error', `Error: ${data.message}`);
                    }
                })
                .catch(err => {
                    showMessage('error', `Network Error: ${err.message}`);
                })
                .finally(() => {
                    if (refreshStructureBtn) refreshStructureBtn.disabled = false;
                    if (showOverlay) {
                        hideEsiOverlay();
                    }
                });
        }

        if (refreshStructureBtn) {
            refreshStructureBtn.addEventListener('click', () => {
                refreshStructureFromESI(true); // Call with overlay
            });
        }

        // --- 8. Event listeners for Add/Delete Squad/Wing ---
        function addStructureButtonListeners() {
            // Add Squad
            document.querySelectorAll('.btn-add-squad').forEach(button => {
                button.addEventListener('click', () => {
                    const wingId = button.dataset.wingId;

                    button.disabled = true;
                    // --- MODIFIED: Use ESI Overlay ---
                    clearMessage();
                    showEsiOverlay('Adding New Squad via ESI...');

                    const formData = new FormData();
                    formData.append('wing_id', wingId);

                    fetch("{% url 'waitlist:api_fc_add_squad' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showMessage('success', data.message);
                                refreshStructureFromESI(false); // Refresh without overlay
                            } else {
                                showMessage('error', `Error: ${data.message}`);
                                button.disabled = false;
                            }
                        })
                        .catch(err => {
                            showMessage('error', `Network Error: ${err}`);
                            button.disabled = false;
                        })
                        // --- NEW: Hide overlay ---
                        .finally(() => {
                            hideEsiOverlay();
                        });
                });
            });

            // Delete Squad
            document.querySelectorAll('.btn-delete-squad').forEach(button => {
                button.addEventListener('click', () => {
                    const squadId = button.dataset.squadId;

                    button.disabled = true;
                    // --- MODIFIED: Use ESI Overlay ---
                    clearMessage();
                    showEsiOverlay('Deleting Squad via ESI...');

                    const formData = new FormData();
                    formData.append('squad_id', squadId);

                    fetch("{% url 'waitlist:api_fc_delete_squad' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showMessage('success', data.message);
                                refreshStructureFromESI(false); // Refresh without overlay
                            } else {
                                showMessage('error', `Error: ${data.message}`);
                                button.disabled = false;
                            }
                        })
                        .catch(err => {
                            showMessage('error', `Network Error: ${err}`);
                            button.disabled = false;
                        })
                        // --- NEW: Hide overlay ---
                        .finally(() => {
                            hideEsiOverlay();
                        });
                });
            });

            // Delete Wing
            document.querySelectorAll('.btn-delete-wing').forEach(button => {
                button.addEventListener('click', () => {
                    const wingId = button.dataset.wingId;

                    button.disabled = true;
                    // --- MODIFIED: Use ESI Overlay ---
                    clearMessage();
                    showEsiOverlay('Deleting Wing via ESI...');

                    const formData = new FormData();
                    formData.append('wing_id', wingId);

                    fetch("{% url 'waitlist:api_fc_delete_wing' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showMessage('success', data.message);
                                refreshStructureFromESI(false); // Refresh without overlay
                            } else {
                                showMessage('error', `Error: ${data.message}`);
                                button.disabled = false;
                            }
                        })
                        .catch(err => {
                            showMessage('error', `Network Error: ${err}`);
                            button.disabled = false;
                        })
                        // --- NEW: Hide overlay ---
                        .finally(() => {
                            hideEsiOverlay();
                        });
                });
            });
        }

        // --- NEW: Add Wing Button Listener ---
        const addWingBtn = document.getElementById('btn-add-wing');
        if (addWingBtn) {
            addWingBtn.addEventListener('click', () => {
                addWingBtn.disabled = true;
                // --- MODIFIED: Use ESI Overlay ---
                clearMessage();
                showEsiOverlay('Adding New Wing via ESI...');

                fetch("{% url 'waitlist:api_fc_add_wing' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showMessage('success', data.message);
                            refreshStructureFromESI(false); // Refresh without overlay
                        } else {
                            showMessage('error', `Error: ${data.message}`);
                        }
                    })
                    .catch(err => {
                        showMessage('error', `Network Error: ${err}`);
                    })
                    .finally(() => {
                        addWingBtn.disabled = false;
                        // --- NEW: Hide overlay ---
                        hideEsiOverlay();
                    });
            });
        }


        // --- On Page Load, if structure section is visible, load it ---
        if (structureSection && structureSection.style.display !== 'none') {
            // --- MODIFIED: Call the ESI refresh on first load ---
            // --- This ensures it's in sync from the start ---
            refreshStructureFromESI(true);
        }
        // ---
        // --- END Fleet Structure Logic
        // ---

        // ---
        // --- REMOVED: FLEET OVERVIEW JAVASCRIPT
        // ---

    });
</script>
{% endblock %}