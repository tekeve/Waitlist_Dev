{% extends "base.html" %}
{% load humanize %}
<!-- Set the page title -->
{% block title %}{{ character.character_name }} - Pilot Details{% endblock %}

<!-- 
FIX: These styles are now wrapped in their own <style> tag 
so they can be correctly injected into the base.html <head>.
-->
{% block styles %}
<style>
    .container {
        max-width: 900px;
        margin: 20px auto; /* Changed margin */
        background: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: max-width 0.3s ease-in-out;
    }

    @media (min-width: 1200px) {
        .container {
            max-width: 1400px; 
        }
    }

    .header {
        display: flex;
        align-items: center;
        gap: 20px;
        border-bottom: 0px solid #444;
        padding-bottom: 20px;
    }
    .header img {
        border-radius: 50%;
        border: 2px solid #555;
    }
    .header h1 {
        margin: 0;
        font-size: 2.5em;
        color: #fff;
    }
    .info {
        font-size: 1.1em;
        color: #ccc;
    }
    .info strong {
        color: #fff;
        font-weight: 600;
    }
    .info small {
        color: #999;
    }

    .section {
        margin-top: 25px;
    }
    .section h2 {
        border-bottom: 0px solid #444;
        padding-bottom: 10px;
        font-size: 1.8em;
        color: #fff;
    }

    /* --- IMPLANT STYLES --- */
    .implant-other-list {
        list-style: none; padding: 0; margin: 0;
        display: flex; flex-direction: column; gap: 4px;
    }

    .implant-grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px; margin-top: 10px;
    }

    @media (min-width: 768px) {
        .implant-grid-container {
            grid-template-columns: 1fr 1fr;
        }
    }

    .implant-column-list {
        list-style: none; padding: 0; margin: 0;
        display: flex; flex-direction: column; gap: 4px;
    }

    .implant-item {
        display: flex; align-items: center; gap: 8px;
        padding: 4px 6px; background: #333; border-radius: 5px;
    }
    .implant-item img {
        width: 32px; height: 32px; border-radius: 4px; flex-shrink: 0;
    }
    .implant-info {
        display: flex; flex-direction: column;
        flex-grow: 1; min-width: 0;
    }
    .implant-slot {
        font-size: 0.7em; font-weight: bold;
        color: #aaa; text-transform: uppercase;
    }
    .implant-name {
        font-size: 0.9em; font-weight: 500; color: #fff;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* --- SKILL STYLES --- */
    .skill-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    .skill-group {
        padding-top: 10px; min-width: 0; 
    }
    .skill-group-header {
        font-size: 0.9em; font-weight: 700; color: #aaa;
        text-transform: uppercase; letter-spacing: 0.5px;
        margin: 0 0 8px 0; padding-bottom: 5px;
        border-bottom: 0px solid #444;
    }
    .skill-list {
        list-style: none; padding: 0; margin: 0;
        display: flex; flex-direction: column; gap: 6px;
    }
    .skill-item {
        display: flex; justify-content: space-between; align-items: center;
    }
    .skill-name {
        font-size: 0.9em; font-weight: 500; color: #ddd;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        padding-right: 10px;
    }
    .skill-level-squares {
        display: flex; gap: 2px; flex-shrink: 0;
    }
    .skill-square {
        width: 10px; height: 10px; background-color: #444;
        border: 0px solid #555;
    }
    .skill-square.trained {
        background-color: #b33a3a; border-color: #c94444;
    }

    /* --- LOADING OVERLAY STYLES --- */
    #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        z-index: 1000; display: none; 
    }
    #loading-overlay.show { display: flex; }
    .spinner {
        width: 60px; height: 60px; border: 6px solid #555;
        border-top-color: #fff; border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    #loading-overlay p {
        color: #fff; font-size: 1.2em; margin-top: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}


<!-- Inject the pilot detail content -->
{% block content %}
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Refreshing ESI Data...</p>
    </div>

    <div class="container">
        <div class="header">
            <img src="{{ portrait_url }}" alt="{{ character.character_name }} portrait" width="128" height="128">
            <div>
                <h1>{{ character.character_name }}</h1>
                <p class="info">
                    <strong>Total SP:</strong> {{ total_sp|intcomma }}<br>
                    <small>Snapshot as of: {{ snapshot_time }}</small>
                </p>
            </div>
        </div>

        <div class="section">
            <h2>Implants</h2>
            
            <ul class="implant-other-list">
                {% for implant in implants_other %}
                    <li class="implant-item" title="{{ implant.name }} ({{ implant.group_name }})">
                        <img src="{{ implant.icon_url }}" 
                             alt="{{ implant.name }}">
                        <div class="implant-info">
                            <span class="implant-slot">
                                {% if implant.slot > 0 %}
                                    Slot {{ implant.slot }}
                                {% else %}
                                    Implant
                                {% endif %}
                            </span>
                            <span class="implant-name">{{ implant.name }}</span>
                        </div>
                    </li>
                {% endfor %}
            </ul>

            <div class="implant-grid-container">
                <ul class="implant-column-list">
                    {% for implant in implants_col1 %}
                        <li class="implant-item" title="{{ implant.name }} ({{ implant.group_name }})">
                            <img src="{{ implant.icon_url }}" 
                                 alt="{{ implant.name }}">
                            <div class="implant-info">
                                <span class="implant-slot">Slot {{ implant.slot }}</span>
                                <span class="implant-name">{{ implant.name }}</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
                <ul class="implant-column-list">
                    {% for implant in implants_col2 %}
                        <li class="implant-item" title="{{ implant.name }} ({{ implant.group_name }})">
                            <img src="{{ implant.icon_url }}" 
                                 alt="{{ implant.name }}">
                            <div class="implant-info">
                                <span class="implant-slot">Slot {{ implant.slot }}</span>
                                <span class="implant-name">{{ implant.name }}</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            
            {% if not implants_other and not implants_col1 and not implants_col2 %}
                <p>No implants found.</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>Skills</h2>
            
            <div class="skill-grid-container">
                {% for group_name, skill_list in grouped_skills.items %}
                    <div class="skill-group">
                        <h3 class="skill-group-header">{{ group_name }}</h3>
                        <ul class="skill-list">
                            {% for skill in skill_list %}
                                <li class="skill-item">
                                    <span class="skill-name" title="{{ skill.name }}">{{ skill.name }}</span>
                                    <div class="skill-level-squares" title="Level {{ skill.level }}">
                                        <span class="skill-square {% if skill.level >= 1 %}trained{% endif %}"></span>
                                        <span class="skill-square {% if skill.level >= 2 %}trained{% endif %}"></span>
                                        <span class="skill-square {% if skill.level >= 3 %}trained{% endif %}"></span>
                                        <span class="skill-square {% if skill.level >= 4 %}trained{% endif %}"></span>
                                        <span class="skill-square {% if skill.level >= 5 %}trained{% endif %}"></span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% empty %}
                    <p>No skills found for this pilot.</p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

<!-- Add page-specific scripts -->
{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const needsRefresh = {{ needs_refresh|yesno:"true,false" }};
            
            if (needsRefresh) {
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('show');
                
                const refreshUrl = "{% url 'pilot:api_refresh_pilot' character.character_id %}";
                const csrfToken = "{{ csrf_token }}";

                fetch(refreshUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('Refresh failed.');
                })
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        throw new Error(data.message || 'Refresh failed.');
                    }
                })
                .catch(error => {
                    console.error('Refresh Error:', error);
                    overlay.innerHTML = `<p style="color: #ff8a8a;">Error refreshing data. Please try logging out and back in.</p>`;
                });
            }
        });
    </script>
{% endblock %}